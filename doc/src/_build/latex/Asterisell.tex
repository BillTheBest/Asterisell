% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\usepackage[utf8]{inputenc}
\DeclareUnicodeCharacter{00A0}{\nobreakspace}
\usepackage[T1]{fontenc}
\usepackage{babel}
\usepackage{times}
\usepackage[Sonny]{fncychap}
\usepackage{longtable}
\usepackage{sphinx}


\title{Asterisell Documentation}
\date{November 11, 2011}
\release{asterisell-free-stable-3.12.00
}
\author{Massimo Zaniboni}
\newcommand{\sphinxlogo}{}
\renewcommand{\releasename}{Release}
\makeindex

\makeatletter
\def\PYG@reset{\let\PYG@it=\relax \let\PYG@bf=\relax%
    \let\PYG@ul=\relax \let\PYG@tc=\relax%
    \let\PYG@bc=\relax \let\PYG@ff=\relax}
\def\PYG@tok#1{\csname PYG@tok@#1\endcsname}
\def\PYG@toks#1+{\ifx\relax#1\empty\else%
    \PYG@tok{#1}\expandafter\PYG@toks\fi}
\def\PYG@do#1{\PYG@bc{\PYG@tc{\PYG@ul{%
    \PYG@it{\PYG@bf{\PYG@ff{#1}}}}}}}
\def\PYG#1#2{\PYG@reset\PYG@toks#1+\relax+\PYG@do{#2}}

\def\PYG@tok@gd{\def\PYG@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\def\PYG@tok@gu{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\def\PYG@tok@gt{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.25,0.82}{##1}}}
\def\PYG@tok@gs{\let\PYG@bf=\textbf}
\def\PYG@tok@gr{\def\PYG@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\def\PYG@tok@cm{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\def\PYG@tok@vg{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\def\PYG@tok@m{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\def\PYG@tok@mh{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\def\PYG@tok@cs{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}\def\PYG@bc##1{\colorbox[rgb]{1.00,0.94,0.94}{##1}}}
\def\PYG@tok@ge{\let\PYG@it=\textit}
\def\PYG@tok@vc{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\def\PYG@tok@il{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\def\PYG@tok@go{\def\PYG@tc##1{\textcolor[rgb]{0.19,0.19,0.19}{##1}}}
\def\PYG@tok@cp{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@gi{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\def\PYG@tok@gh{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\def\PYG@tok@ni{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.84,0.33,0.22}{##1}}}
\def\PYG@tok@nl{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.13,0.44}{##1}}}
\def\PYG@tok@nn{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.05,0.52,0.71}{##1}}}
\def\PYG@tok@no{\def\PYG@tc##1{\textcolor[rgb]{0.38,0.68,0.84}{##1}}}
\def\PYG@tok@na{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\def\PYG@tok@nb{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@nc{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.05,0.52,0.71}{##1}}}
\def\PYG@tok@nd{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.33,0.33,0.33}{##1}}}
\def\PYG@tok@ne{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@nf{\def\PYG@tc##1{\textcolor[rgb]{0.02,0.16,0.49}{##1}}}
\def\PYG@tok@si{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.44,0.63,0.82}{##1}}}
\def\PYG@tok@s2{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\def\PYG@tok@vi{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\def\PYG@tok@nt{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.02,0.16,0.45}{##1}}}
\def\PYG@tok@nv{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\def\PYG@tok@s1{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\def\PYG@tok@gp{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.78,0.36,0.04}{##1}}}
\def\PYG@tok@sh{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\def\PYG@tok@ow{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@sx{\def\PYG@tc##1{\textcolor[rgb]{0.78,0.36,0.04}{##1}}}
\def\PYG@tok@bp{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@c1{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\def\PYG@tok@kc{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@c{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\def\PYG@tok@mf{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\def\PYG@tok@err{\def\PYG@bc##1{\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{##1}}}
\def\PYG@tok@kd{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@ss{\def\PYG@tc##1{\textcolor[rgb]{0.32,0.47,0.09}{##1}}}
\def\PYG@tok@sr{\def\PYG@tc##1{\textcolor[rgb]{0.14,0.33,0.53}{##1}}}
\def\PYG@tok@mo{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\def\PYG@tok@mi{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\def\PYG@tok@kn{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@o{\def\PYG@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\def\PYG@tok@kr{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@s{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\def\PYG@tok@kp{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@w{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\def\PYG@tok@kt{\def\PYG@tc##1{\textcolor[rgb]{0.56,0.13,0.00}{##1}}}
\def\PYG@tok@sc{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\def\PYG@tok@sb{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\def\PYG@tok@k{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\def\PYG@tok@se{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\def\PYG@tok@sd{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}

\def\PYGZbs{\char`\\}
\def\PYGZus{\char`\_}
\def\PYGZob{\char`\{}
\def\PYGZcb{\char`\}}
\def\PYGZca{\char`\^}
\def\PYGZsh{\char`\#}
\def\PYGZpc{\char`\%}
\def\PYGZdl{\char`\$}
\def\PYGZti{\char`\~}
% for compatibility with earlier versions
\def\PYGZat{@}
\def\PYGZlb{[}
\def\PYGZrb{]}
\makeatother

\begin{document}

\maketitle
\tableofcontents
\phantomsection\label{index::doc}



\chapter{Usage Scenario}
\label{index:asterisell-overview}\label{index:usage-scenario}
Asterisell is a web application for rating, showing to customers, and billing VoIP calls.
\begin{description}
\item[{Usage scenario:}] \leavevmode\begin{itemize}
\item {} 
you are a vendor of Voice over IP Telephony (VoIP) services;

\item {} 
your {\hyperref[index:term-customer]{\emph{customers}}} pay you for this service;

\item {} 
your customers can call users residing on telephone networks that are not directly managed/owned from you;

\item {} 
for routing calls to external networks, you use the services of other {\hyperref[index:term-voip-vendor]{\emph{telephone vendors}}}, and you pay them for this service;

\end{itemize}

\item[{Every call has:}] \leavevmode\begin{itemize}
\item {} 
an income: what your {\hyperref[index:term-customer]{\emph{customer}}} pays to you;

\item {} 
a cost: what you pay to other telephone service vendors ({\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}}) in order to route the call;

\item {} 
an earn: the difference between the income and the cost;

\end{itemize}

\item[{You can use Asterisell for:}] \leavevmode\begin{itemize}
\item {} 
rating calls;

\item {} 
showing to your customers details about their calls;

\item {} 
billing your customers;

\item {} 
calculating what you owe to other telephone service vendors ({\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}})

\end{itemize}

\end{description}

You can have different {\hyperref[index:term-partner]{\emph{partners}}}, and different {\hyperref[index:term-reseller]{\emph{resellers}}}.


\chapter{Installation}
\label{index:installation}

\section{Requirements}
\label{index:requirements}\begin{itemize}
\item {} 
HTTP WEB Server;

\item {} 
PHP 5.0 or greater (PHP 4.0 is not supported);

\item {} 
\href{http://www.php.net/manual/en/image.installation.php}{GD support} enabled in PHP;

\item {} 
MySQL DBMS;

\end{itemize}


\section{Software Infrastructure}
\label{index:software-infrastructure}\begin{description}
\item[{VoIP calls are managed usually from an \href{http://www.asterisk.org}{Asterisk Server}}] \leavevmode\begin{itemize}
\item {} 
it routes the calls to the proper dial peer;

\item {} 
it associates to every customer a unique ``accountcode'';

\item {} 
it writes Call Detail Records (CDRs) on a specific MySQL database table shared with Asterisell.

\end{itemize}

\end{description}

VoIP calls can be managed from other servers, or call detail records can be imported from CSV files.
\begin{description}
\item[{Asterisell is a PHP5 web application that:}] \leavevmode\begin{itemize}
\item {} 
reads calls information from the CDR table shared with Asterisk Server;

\item {} 
associate to every call a cost (what the service provider pays to other vendors for routing the customer's call);

\item {} 
associate to every call an income (what the customer pays to the service provider);

\item {} 
displays calls info;

\end{itemize}

\end{description}


\section{Download}
\label{index:download}\begin{description}
\item[{The suggested way to download this release is using \href{http://git-scm.com/}{Git version control system} . This allows to:}] \leavevmode\begin{itemize}
\item {} 
download application updates in an efficient way;

\item {} 
be advised of conflicts between your customizations and application updates;

\item {} 
send back to me bug-fixes and improvements;

\item {} 
receive improvements from other in an efficient way;

\item {} 
upgrade to commercial release easily without loosing your customizations;

\end{itemize}

\end{description}

For initial download:

\begin{Verbatim}[commandchars=@\[\]]
git clone http://github.com/massimo-zaniboni/Asterisell.git
\end{Verbatim}

For updating/upgrading to new releases:

\begin{Verbatim}[commandchars=@\[\]]
git commit -a -m "My custom changes."
git pull http://github.com/massimo-zaniboni/Asterisell.git
\end{Verbatim}

Then follow the Git procedure to resolve merge conflicts. Usually there will not merge conflicts, because Git tries to preserve both you customization and new version modifications.

In case of troubles, ask to forum. I will update these installation notes, according the signaled problems/suggestions.


\section{Asterisell Installation}
\label{index:asterisell-installation}

\subsection{Asterisell File Installation}
\label{index:asterisell-file-installation}
Choose a directory where installing Asterisell. For example \emph{/var/www/asterisell3}.

In Linux Debian make sure that the ``www-data'' user can read the content of the installation directory:

\begin{Verbatim}[commandchars=@\[\]]
chown -R :www-data asterisell3
chmod -R g+rwx asterisell3
\end{Verbatim}


\subsection{Packages}
\label{index:packages}\begin{description}
\item[{The typical installation requires:}] \leavevmode\begin{itemize}
\item {} 
Apache2 HTTP server

\item {} 
mod\_php5

\item {} 
mod\_ssl

\item {} 
MySQL database server

\item {} 
awk

\end{itemize}

\end{description}

Asterisell use some PHP5 libraries. On Fedora/Centos for example you must install:

\begin{Verbatim}[commandchars=@\[\]]
yum install awk
yum install httpd
yum install php php-cli php-common
yum install mysql mysql-server php-mysql
yum install php-bcmath php-xml php-mbstring
\end{Verbatim}

and then execute:

\begin{Verbatim}[commandchars=@\[\]]
/etc/init.d/httpd restart
\end{Verbatim}


\section{MySQL Database Configuration}
\label{index:mysql-database-configuration}
Up to date Asterisell is tested only with \href{http://www.mysql.com}{MySQL DBMS} , but the Symfony framework support many other popular open source DBMS.


\subsection{Database Access Parameters}
\label{index:database-access-parameters}
Update:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{n}{config}\PYG{o}{/}\PYG{n}{databases}\PYG{o}{.}\PYG{n}{yml}
\PYG{n}{config}\PYG{o}{/}\PYG{n}{propel}\PYG{o}{.}\PYG{n}{ini}
\PYG{n}{scripts}\PYG{o}{/}\PYG{n}{initdb}\PYG{o}{.}\PYG{n}{sh}
\end{Verbatim}

according your needs using the correct host, username and password for MySQL access.

Initially you must use the root/admin account of MySQL, because  configuration scripts will create a new database. Later you can create a specific user for the Asterisell database, in order to limit the capability of the Asterisell user.

The suggested database name is \emph{asterisell3} in order to avoid conflicts with previous or new version of Asterisell needing different database schemas.


\subsection{How to create a Database User with Limited Access to Asterisell Database}
\label{index:how-to-create-a-database-user-with-limited-access-to-asterisell-database}
Enter into MySQL shell:

\begin{Verbatim}[commandchars=@\[\]]
mysql -u root -p mysql
\end{Verbatim}

Create a user that can invoke MySQL only from localhost (supposing that Asterisell webserver hosts also the MySQL DBMS):

\begin{Verbatim}[commandchars=@\[\]]
CREATE USER 'asterisell3user'@PYGZat[]'localhost' IDENTIFIED BY 'some-password-here';
GRANT ALL ON asterisell3.* TO 'asterisell3user'@PYGZat[]'localhost';
\end{Verbatim}

This example, supposes that \emph{asterisell3} is the name of created Asterisell database, and \emph{asterisell3user} the name of database user.

NOTE: \emph{GRANT ALL} is needed in order to support the database upgrade script.


\subsection{Installation Script}
\label{index:installation-script}\begin{description}
\item[{The installation script will:}] \leavevmode\begin{itemize}
\item {} 
create a new \emph{asterisell3} database;

\item {} 
load the tables;

\item {} 
initializing the Asterisell application with demo data;

\item {} 
fix directory permissions;

\item {} 
reset the Symfony cache;

\end{itemize}

\end{description}

It must not be used if it is an update of Asterisell, because otherwise all data will be lost.

In any case the script will warn you about this.

Execute:

\begin{Verbatim}[commandchars=@\[\]]
cd scripts
sh initdb.sh
\end{Verbatim}

and answer to questions.

The very last versions of MySQL requires \emph{Engine=InnoDB;} instead of \emph{Type=InnoDB;} inside file \emph{data/sql/lib.model.schema.sql}. In case of problems during database creation (initial installation of Asterisell), you must update manually this file.


\subsection{Change Demo Data Later}
\label{index:change-demo-data-later}
The installation script will load also some demo data in order to test Asterisell.

If you want later, start with an empty database, you can execute:

\begin{Verbatim}[commandchars=@\[\]]
cd scripts
php reset@_db@_and@_init@_data.php init @textless[]some-password-for-root-user-access@textgreater[]
\end{Verbatim}

for creating an empty database, with only minimal data, and a ``root'' user with the chosen password for initial login.

The scripts supports other type of data initialization. This command will display all its options:

\begin{Verbatim}[commandchars=@\[\]]
cd scripts
php reset@_db@_and@_init@_data.php
\end{Verbatim}

You can also inspect the content of \emph{scripts/initdb.sh} in order to see the details of performed actions.


\subsection{Optional Configuration for Developers}
\label{index:optional-configuration-for-developers}
If you are a developer, and you are changing Asterisell source code, maybe you want to change also its database schema, contained in \emph{config/schema.yml}.

In this case, you must also instruct \emph{config/propel.ini} about how to access the MySQL database. These are the same parameters of \emph{config/databases.yml}, but they are used from a different tool, and so they must be repeated here.

Update \emph{config/propel.ini} according your needs.

Adapt it, using the same parameters of the \emph{databases.yml}. This file contains a lot of parameters, but you must only change these lines:

\begin{Verbatim}[commandchars=@\[\]]
propel.database.createUrl  = mysql://localhost/
propel.database.url        = mysql://localhost/asterisell3
propel.output.dir          = /var/www/asterisell3
\end{Verbatim}

If you have changed the database structure in the file \emph{config/schema.yml}, you must also update the SQL instructions creating the MySQL database. You can use the script \emph{scripts/makedb.sh}. It will recreate the SQL commands and then it call \emph{initdb.sh} in order to load the new database.


\section{Web Server}
\label{index:web-server}

\subsection{Website Configuration}
\label{index:website-configuration}\begin{description}
\item[{Create the file \emph{asterisell.conf} inside the directory:}] \leavevmode\begin{itemize}
\item {} 
\emph{/etc/httpd/conf.d/} or

\item {} 
\emph{/etc/apache2/conf.d/}

\end{itemize}

\end{description}

The content is something like:

\begin{Verbatim}[commandchars=@\[\]]
Alias /your-voip-service /var/www/asterisell3/web/

@textless[]Location /your-voip-service@textgreater[]
  Order allow,deny
  Allow from all

  @# If you have mod@_ssl installed
  @# then with these lines you can force the usage of https connections
  @# for all Asterisell access.
  @# If you omit them, then the passwords are sent in plain text and
  @# they can be intercepted from hackers...
  @#
  AllowOverride All
  @textless[]IfModule mod@_rewrite.c@textgreater[]
    RewriteEngine On
    RewriteCond @%{HTTPS} off
    RewriteRule (.*) https://@%{HTTP@_HOST}@%{REQUEST@_URI}
  @textless[]/IfModule@textgreater[]

@textless[]/Location@textgreater[]
\end{Verbatim}

NOTE: remember to add \emph{/web} to your Asterisell installation directory. This because it is only the \emph{web} subdirectory of Asterisell project that must be part of the web-space.

Restart the apache2 httpd server in order to render active the configurations using a command like:

\begin{Verbatim}[commandchars=@\[\]]
/etc/init.d/httpd restart
\end{Verbatim}

or:

\begin{Verbatim}[commandchars=@\[\]]
/etc/init.d/apache2 restart
\end{Verbatim}

If it is all correct then \emph{http://your-voip-service} will display the login form.


\subsection{PHP Resources}
\label{index:php-resources}
The administrator can invoke heavy jobs, for example graph and stats about calls. In this case it is usefull to increase the resources of PHP scripts inside on-line sessions.

In CENTOS the settings are in \emph{/etc/php.ini}, in Debian are in \emph{/etc/php5/apache2/php.ini}. Change somethiing like:

\begin{Verbatim}[commandchars=@\[\]]
;;;;;;;;;;;;;;;;;;;
; Resource Limits ;
;;;;;;;;;;;;;;;;;;;

max@_execution@_time = 30     ; Maximum execution time of each script, in seconds
max@_input@_time = 60 ; Maximum amount of time each script may spend parsing request data
;max@_input@_nesting@_level = 64 ; Maximum input variable nesting level
memory@_limit = 128M      ; Maximum amount of memory a script may consume (128MB)
\end{Verbatim}

into something like:

\begin{Verbatim}[commandchars=@\[\]]
;;;;;;;;;;;;;;;;;;;
; Resource Limits ;
;;;;;;;;;;;;;;;;;;;

max@_execution@_time = 180     ; Maximum execution time of each script, in seconds
max@_input@_time = 60 ; Maximum amount of time each script may spend parsing request data
;max@_input@_nesting@_level = 64 ; Maximum input variable nesting level
memory@_limit = 128M      ; Maximum amount of memory a script may consume (128MB)
\end{Verbatim}

increasing the execution time from 30 seconds to 180 seconds.

NOTE: heavy jobs like email sending, are done from the cron-job, in off-line mode, and they are not affected from these settings / constraints.


\subsection{PHP Speedup}
\label{index:php-speedup}
\href{http://pecl.php.net/package/APC}{APC} is a free, open source framework that caches data and compiled code from the PHP bytecode compiler in shared memory.

I suggest installing it, because it is well tested, and it speeds-up a lot the execution of Asterisell and other PHP applications.

For installing it in Debian:

\begin{Verbatim}[commandchars=@\[\]]
aptitude install php-apc
\end{Verbatim}

or in CENTOS follow \href{http://2bits.com/articles/installing-php-apc-gnulinux-centos-5.html}{the instruction of this webpage} (up to date the APC package is not part of CENTOS).

IMPORTANT: In order to activate it, the Apache web server must be restarted.

IMPORTANT: Up to date there can be conflicts between APC (version 3.0.19) and SwiftMailer. If after the sending of the first mail, an error message appears in the problem table (something like \emph{Fatal error: Cannot inherit previously-inherited or override constant LEVEL\_TOP from interface Swift\_Mime\_Message}), then try to upgrade APC or disactivate APC.


\subsection{MySQL}
\label{index:mysql}
Rates based on CSV files can be rather big, because they contain a lot of data. Asterisell save them in a record, and the SQL command can be rather big.

So you must use a reasonable \emph{max\_allowed\_packet} size, for communication between PHP and MySQL.

Check that inside \emph{/etc/mysql/my.cnf} there is something like:

\begin{Verbatim}[commandchars=@\[\]]
@PYGZlb[]mysqld@PYGZrb[]
max@_allowed@_packet = 16M
\end{Verbatim}

In case of problems, increase this limit, and then restart MySQL (NOTE: during restart new inserted CDR records will be lost):

\begin{Verbatim}[commandchars=@\[\]]
/etc/init.d/mysql restart
\end{Verbatim}

Last versions of MySQL execute a fsync (flush) on disk for every transaction. This is a very big slow down for Asterisell, because it does not group batch work on CDRs on a single transaction. If MySQL is slow, it can be configured for flushing on disk the transactions every seconds. Add inside \emph{/etc/mysql/my.cnf}:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{n}{innodb\PYGZus{}flush\PYGZus{}log\PYGZus{}at\PYGZus{}trx\PYGZus{}commit} \PYG{o}{=} \PYG{l+m+mi}{0}
\end{Verbatim}

Consult \href{http://dev.mysql.com/doc/refman/4.1/en/innodb-parameters.html\#sysvar\_innodb\_flush\_log\_at\_trx\_commit}{MySQL related documentation} for more details on side effects of this setting.


\subsection{Additional File Access Permissions}
\label{index:additional-file-access-permissions}
If you have not used the default installation script (\emph{scripts/initdb.sh}), then make sure to execute:

\begin{Verbatim}[commandchars=@\[\]]
./symfony fix-perms
\end{Verbatim}

or:

\begin{Verbatim}[commandchars=@\[\]]
chmod -R a+rw log
chmod -R a+rw cache
\end{Verbatim}

in order to enable the write rights on (only) these two directories.


\section{Cron Job}
\label{index:cron-job}

\subsection{Calls Rating and Jobs Processing}
\label{index:calls-rating-and-jobs-processing}
Asterisell rates the calls and execute other jobs off-line, using a cron-job process. This allows to use all the resources of the machine, without the constraints of online sessions.

The list of jobs to execute and the various parameters are inside \emph{apps/asterisell/config/app.yml}.

In case of problems during job execution, a mail is sent to the administrator.


\subsection{User Permissions}
\label{index:user-permissions}
The process must be executed from the same user that is associated to the http connection.

On Fedora/Centos it is typically \emph{apache}, on Debian \emph{www-data}. In order to retrieve it, you can enter into Asterisell web interface, select Help menu and PHP-INFO option. Then you can search the element \emph{User/Group}. The first value is the name of the PHP/webserver user.


\subsection{Cron Job Setting}
\label{index:cron-job-setting}
Supposing the http user is ``apache'' you can associate to it a cron job using the command:

\begin{Verbatim}[commandchars=@\[\]]
crontab -u apache -e
\end{Verbatim}

This command will open an editor. If the defalt editor is \emph{vi}, then digit \emph{:i} (and press enter) in order to start editing, and \emph{:wq} (and press enter) at the end of editing, in order to \emph{write} and \emph{quit/exit} from the editor

Add this line:

\begin{Verbatim}[commandchars=@\[\]]
5,10,15,20,25,30,35,40,45,50,55 * * * * sh -c "cd /your-asterisell-dir/scripts/ ; nice php process@_jobs.php @textgreater[] /dev/null "
\end{Verbatim}

The meaning of the line is to execute at minutes 5, 10, 15, 20, ... of every hour the \emph{php rate\_all\_and\_test.php} command inside the Asterisell directory.


\subsection{Log Rotate}
\label{index:log-rotate}
In order to reduce log file size put \emph{asterisell-logrotate} with execution privileges in \emph{/etc/cron.monthly} directory:

\begin{Verbatim}[commandchars=@\[\]]
@#!/bin/sh
cd /your-asterisell-install-dir
./symfony log-rotate asterisell prod
\end{Verbatim}

and set it as an executable file

\begin{Verbatim}[commandchars=@\[\]]
chmod u+x asterisell-logrotate
\end{Verbatim}

Note that \emph{asterisell} after \emph{symfony} command is the name of the application and it is not depends from the directory installation.


\section{Asterisell Customizations}
\label{index:asterisell-customizations}\label{index:id1}

\subsection{Jobs/Workflow Customizations}
\label{index:jobs-workflow-customizations}\begin{description}
\item[{Asterisell uses a blackboard approach to process information:}] \leavevmode\begin{itemize}
\item {} 
events are put inside the database/blackboard;

\item {} 
customizable/configurable jobs react to events;

\item {} 
jobs can produce new events;

\end{itemize}

\end{description}

In this way it is possible to add new jobs, changing the behaviour of the application.

If you add new \emph{jobs} make sure to add them to the \emph{apps/asterisell/lib/jobs/userjobs}, otherwise during subsequent update of Asterisell application, all new jobs could be lost or there can be a lot of Git merge conflicts.

Some Jobs like PDF invoicing, email composition and so on require some customization. You can create a custom Job modifying already existing jobs, put them in \emph{apps/asterisell/lib/jobs/userjobs} directory. The more elegant way is to change also the name of the job, add it to the \emph{apps/asterisell/config/app.yml} file, removing the old job.


\subsection{Rates Customizations}
\label{index:rates-customizations}\begin{description}
\item[{New type of rate methods can be added:}] \leavevmode\begin{itemize}
\item {} 
add a new rate inside \emph{apps/asterisell/lib/rates}

\item {} 
enable the rate inside \emph{apps/asterisell/config/app.yml}

\item {} 
refresh the cache \emph{./configure.sh}

\end{itemize}

\end{description}


\section{Troubleshooting}
\label{index:troubleshooting}

\subsection{File Permissions}
\label{index:file-permissions}

\subsubsection{Log Directory}
\label{index:log-directory}
Often after upgrades there are problems related to the Asterisell log files inside log directory.

If this file was created from root then the \emph{apache} user is not able to add info to it and the entire Asterisell application is blocked. In this case change the permissions of file with something like:

\begin{Verbatim}[commandchars=@\[\]]
cd log
chmod a+rw asterisell@_prod.log
chmod a+rw asterisell@_dev.log
\end{Verbatim}

or better change the owner in something like:

\begin{Verbatim}[commandchars=@\[\]]
cd log
chown apache asterisell@_prod.log
chown apache asterisell@_dev.log
\end{Verbatim}

or execute:

\begin{Verbatim}[commandchars=@\[\]]
./symfony fix-perms
\end{Verbatim}

Try also to restart the web server.


\subsubsection{Created Files}
\label{index:created-files}
During initial Asterisell configuration new files can be created. Check if these files are readable from web-server process. For example on my debian machine I performs:

\begin{Verbatim}[commandchars=@\[\]]
chown -R :www-data *
chmod -R g+rx *
sh configure.sh
\end{Verbatim}

where \emph{www-data} is the group used from my webserver.


\subsection{Additional Run-Time Debug Info}
\label{index:additional-run-time-debug-info}
In case of problems you can enable the development/debug version of Asterisell that shows useful informations about its execution and related problems. Execute:

\begin{Verbatim}[commandchars=@\[\]]
./symfony enable asterisell dev
\end{Verbatim}

and open the url \emph{http://your-web-url/asterisell\_dev.php/login}

When finished remember to execute:

\begin{Verbatim}[commandchars=@\[\]]
./symfony disable asterisell dev
\end{Verbatim}

NOTE: on the contrary of Asterisell production version, in the development version if you change Asterisell source code, you must not execute \emph{sh configure.sh}, because the development version recreate all files every time in order to speed up development at the expense of run-time executions.

NOTE: as in the Asterisell product version, in the development version if you change some configuration parameters you must execute \emph{sh configure.sh} because certain Asterisell modules are regenerated according the configured values.


\subsection{Run Time Configuration Problems}
\label{index:run-time-configuration-problems}
Every problem encountered from Asterisell during the call rating process is clearly reported to the administrator with hints of how to resolve it.

The presence of problems is signaled also via email to the administrator.

In case of dubious configurations Asterisell advise the administrator and suspend the rate of affected calls.
\begin{description}
\item[{The rate process is rather robust and error-free regarding ill defined configurations because:}] \leavevmode\begin{itemize}
\item {} 
re-rating of calls is always possible;

\item {} 
problems are always signaled;

\end{itemize}

\end{description}


\subsection{Feedback}
\label{index:feedback}
Web servers, PHP environment, libraries, and os on... can interact in strange ways. If something is not working properly let me know!


\section{Security}
\label{index:security}
The end user interacts only with the \emph{Call Report} form. The content of user input fields is checked by a very conservative function that removes every non proper character.

No particular care is put on other forms because they are accessible only from the administrator.

User session handling is managed directly from Symfony and PHP engine.


\section{MySQL advanced optimizations}
\label{index:mysql-advanced-optimizations}
For obtaining a 10x-20x speedup of call-report and related queries, the CDRs of last 1-2 months must be saved in the MySQL database cache in RAM. This makes a big difference in performances. Make sure having a \emph{my.cnf} file like this:

\begin{Verbatim}[commandchars=@\[\]]
@PYGZlb[]mysqld@PYGZrb[]
@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#
@# ASTERISELL RELATED SETTINGS @#
@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#@#
@# Optimize InnoDB performances for Asterisell usage.
@# NOTE: it will use the majority of the RAM of the server
@# for Asterisell and other MySQL databases.
@#
@# Set this to 60-80@% the RAM of the server
innodb@_buffer@_pool@_size = 1G

sort@_buffer@_size = 50M
thread@_cache@_size = 4
tmp@_table@_size = 50M
sync@_binlog = 0

@# not very important
innodb@_additional@_mem@_pool@_size = 10M

@# Commits are flushed on the disk each second,
@# and not immediately.
innodb@_flush@_log@_at@_trx@_commit = 0

innodb@_lock@_wait@_timeout = 50
table@_cache = 92
innodb@_flush@_method=O@_DIRECT

@# speed-up rating of CDRs and also other performances - very important
innodb@_log@_buffer@_size = 8M
\end{Verbatim}

Restart MySQL for enabling changes in configuration.


\chapter{Configurations}
\label{index:configurations}

\section{Main Configurations}
\label{index:main-configurations}\label{index:id2}
\code{apps/asterisell/config/app.yml} contains the main configurations of Asterisell. Once they are properly configured, they rarely change.

The meaning of various settings are explained directly inside the file comments. Details of some settings will be explained in other tasks. Initially set only parameters of witch you are sure, leaving default values otherwise.

In order to make active the changes, you must execute \textbf{./configure.sh}.

{\hyperref[index:main-configuration-file]{\emph{Main Configuration File Content}}}.


\section{Asterisell Owner Params}
\label{index:asterisell-owner}\label{index:asterisell-owner-params}
Use \emph{Params \(\rightarrow\) Params \(\rightarrow\) Default} for defining the params of {\hyperref[index:term-asterisell-owner]{\emph{Asterisell owner}}}.


\section{Web Site Appearances}
\label{index:web-site-appearances}
Logo, slogan, title, footer and similar aspects of the web-site can be customized directly from {\hyperref[index:asterisell-owner]{\emph{Asterisell Owner Params}}}.

Web Site appearance can be further customized changing \emph{apps/asterisell/templates/asterisell\_layout.php} and \emph{web/css} content.


\section{Vendors Specification}
\label{index:vendors-specification}\label{index:id3}
Use \emph{Parties \(\rightarrow\) Customers / Vendors} for defining a {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}}.

Use \emph{Rates} for creating rates associated to the {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}}, calculating the cost of calls.

You can define one or more vendors, and you can use different vendors for different calls, associating cost rates to corresponding VoIP vendor.


\section{Customers Specification}
\label{index:customers-specification}
Use \emph{Parties \(\rightarrow\) Customers / Vendors} for defining a {\hyperref[index:term-customer]{\emph{customer}}}.

Use \emph{Parties \(\rightarrow\) Customer Offices} for defining one or more  {\hyperref[index:term-customer-office]{\emph{customer office}}} associated to a customer.

Use \emph{Parties \(\rightarrow\) VoIP Accounts} for defining one or more  {\hyperref[index:term-voip-account]{\emph{VoIP account}}}, associated to an office.

The {\hyperref[index:term-call-report]{\emph{call report}}} will display office and account information only when they are relevant. They are not displayed in case of logged customers with only one office, or only one VoIP account.

If a customer is not more active, disable the \code{Is Active} flag. Invoices associated to the customer will not generated.


\section{Telephone Prefixes in Call Report}
\label{index:telephone-prefixes-in-call-report}\label{index:telephone-prefixes}
The call report contains something like

\begin{tabulary}{\linewidth}{|L|L|L|}
\hline
\textbf{
Tel.Tr.
} & \textbf{
Location
} & \textbf{
Connection
}\\
\hline

3932894234XXX
1707782466XXX
 & 
Italy
USA
 & 
Mobile Line
Fixed Line
\\
\hline
\end{tabulary}


The table associates a \emph{location} and a \emph{connection type} to a telephone number.
\begin{description}
\item[{This association is done inspecting the \emph{Params \(\rightarrow\) Telephone Prefixes} table:}] \leavevmode\begin{itemize}
\item {} 
A prefix like ``39'' can be associated to a generic ``Italian Operator''.

\item {} 
A prefix like ``393'' can be associated to a generic (but more specific) ``Mobile Italian Operator''.

\item {} 
A prefix like ``39328'' can be associated to the specific ``Wind Mobile Italian Operator''.

\item {} 
A telephone number is associated to its more specific prefix. So ``3944444'' is associated to ``Italian Operator'', while ``39344444'' to ``Mobile Italian Operator'' and finally ``393284444'' to ``Wind Mobile Italian Operator''.

\end{itemize}

\end{description}

CDRs must be rerated again, in order to see the effects of changes in the table.

Telephone Prefix table is not used in rating process, but only in call report.

Initial Asterisell installation already load a complete list of standard world-wide prefixes. You can manually add custom prefixes associated to your specific settings.
\begin{description}
\item[{The table can be completed also importing from a CSV file:}] \leavevmode\begin{itemize}
\item {} 
\emph{Params \(\rightarrow\) Rates}.

\item {} 
Create a pseudo rate of type \emph{CSV File with Tel.Prefixes and Rates}.

\item {} 
Set the rate according the format of the CSV file.

\item {} 
Make sure activating \emph{Update also prefix table}.

\item {} 
Press \emph{Save} button.

\item {} 
Note that in default settings, local numbers are stored internally in their complete form with the international prefix. Make sure that it is part of the table.

\item {} 
Delete the rate.

\item {} 
Check the prefix table.

\end{itemize}

\end{description}


\section{Rates}
\label{index:cdr-rating-process}\label{index:rates}
Rates classify every {\hyperref[index:term-cdr]{\emph{CDR}}}, and associate a cost and an income to them.


\subsection{Classification Rates}
\label{index:classification-rates}
A new {\hyperref[index:term-cdr]{\emph{CDR}}} starts with state unprocessed, and they are initially managed from {\hyperref[index:term-classification-rate]{\emph{classification rate}}}. They inspect mainly the amaflags and disposition fields where Asterisk server put billing hints/information.
\begin{description}
\item[{A classification rate classifies a call:}] \leavevmode\begin{itemize}
\item {} 
as \code{outgoing}, if the call is made from the customer to an external telephone number;

\item {} 
as \code{incoming}, it the call is from an external telephone number to the customer VoIP number;

\item {} 
as \code{internal}, if the call is made from the customer to an internal VoIP account;

\item {} 
as \code{ignore}, if the CDR can be ignored;

\end{itemize}

\end{description}


\subsection{Telephone Number Normalizations}
\label{index:telephone-number-normalizations}\begin{description}
\item[{Advanced CDR processing can be performed from customized \code{classification rates}, that are usually created from developers according the specific needs of Asterisell instance. Some example of doable operations are:}] \leavevmode\begin{itemize}
\item {} 
recognition of complex patterns for local/mobile/interstate/intrastate telephone numbers;

\item {} 
ad-hoc formatting of telephone numbers according their type;

\item {} 
recognition of off-peak, peak or week-end calls, according the call-time;

\end{itemize}

\end{description}

These operations are performed by custom PHP code, so you must consult Asterisell assistance and support.


\subsection{Ignored CDRs}
\label{index:ignored-cdrs}\begin{description}
\item[{CDRs of type \code{ignore} are not further processed:}] \leavevmode\begin{itemize}
\item {} 
they are not displayed in the {\hyperref[index:term-call-report]{\emph{call report}}};

\item {} 
they are not billed;

\item {} 
their fields can be in a bad format;

\end{itemize}

\end{description}

They remain in the {\hyperref[index:term-cdr-table]{\emph{CDR table}}}, but they are ignored.

Note that they are not deleted, and in case of change of the classification rate, usually during initial phase of Asterisell customized deployment, the ignored CDRs can be re-rated as all other CDRs, and in case they can become CDRs of other type, if the classification logic is changed.


\subsection{Internal CDRs}
\label{index:internal-cdrs}
CDRs of type \code{internal} are calls between two local VoIP users.

Usually they have no cost, so they are usually associated to rates saying their cost and income is simply 0.

They can be displayed or not displayed in the {\hyperref[index:term-call-report]{\emph{call report}}}, according the setting \code{show\_internal\_calls} in {\hyperref[index:main-configurations]{\emph{Main Configurations}}}. If they are not displayed in the call report, then they are also ignored during the invoice phase. The administrator views always all the type of calls, except ignored calls, because he must have a complete vision of CDR table content.


\subsection{Incoming Calls}
\label{index:incoming-calls}
Incoming calls usually have no cost, so they are usually associated to rates saying their cost and income is simply 0.

They can be displayed or not displayed in the {\hyperref[index:term-call-report]{\emph{call report}}}, according the setting \code{show\_incoming\_calls} in {\hyperref[index:main-configurations]{\emph{Main Configurations}}}. If they are not displayed in the call report, then they are also ignored during the invoice phase. The administrator views always all the type of calls, except ignored calls, because he must have a complete vision of CDR table content.


\subsection{Revenue Sharing}
\label{index:revenue-sharing}
A call can have a negative cost. In this case you (as {\hyperref[index:term-asterisell-owner]{\emph{Asterisell owner}}}) are earning something for the call. There can be a revenue sharing between the {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}} and you (as {\hyperref[index:term-asterisell-owner]{\emph{Asterisell owner}}}). This can be the case for incoming calls for mobile telephone numbers.

A call can have a negative income. In this case there can be a revenue sharing between your customer and you.

Separate invoices can be created for revenue sharing, setting the \code{Is Revenue Sharing} field, during invoice generation. All the CDRs with negative incomes are part of revenue sharing invoices.


\subsection{Normal Rates}
\label{index:normal-rates}
CDRs of type \code{outgoing}, \code{incoming}, \code{internal} are processed from \code{normal rates}, for determining their cost and income.

Income rates are associated to the customers of a specific price category.

Cost rates are associated to a specific {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}}.


\subsection{Rate Priorities}
\label{index:rate-priorities}
There can be one or more rates applicable to a CDR. It is always used the most specific rate. When there are doubts about which is the most specific rate, an error is generated, and the CDR remains unprocessed.

Every rate have a priority method. Two rates are comparable if they have the same priority method. If there are two rates applicable to the same CDR, but with two different priority method, an error is generated, because there is no way for determining what is the most specific rate.

Usually classification rates use destination channel as priority method, and normal rates the {\hyperref[index:term-external-telephone-number]{\emph{external telephone number}}}.
\begin{description}
\item[{For example given:}] \leavevmode\begin{itemize}
\item {} 
a rate \code{A} with the {\hyperref[index:term-external-telephone-number]{\emph{external telephone number}}} priority method, matching numbers like \code{123};

\item {} 
a rate \code{B} matching numbers like \code{1234};

\item {} 
a telephone number \code{AA} like \code{12355555};

\item {} 
a telephone number \code{BB} like \code{12344444};

\end{itemize}

\end{description}

then the rate \code{A} is the best match for \code{AA}, while \code{B} is the best match for \code{BB}.

A rate can have the \code{exception} field activated. They have a greater priority respect no exception rates. The most specific exception is selected, if there is any. This allows creating special rating rules, having priority methods different from other normal rates.


\subsection{Price Categories}
\label{index:price-categories}
Income rates have a price category. They are applicable only to customers of the same price category. Example of price categories can be \code{normal}, \code{discounted}, \code{reseller}.

Price categories must be assigned to every {\hyperref[index:term-customer]{\emph{customer}}}, and optionally to {\hyperref[index:term-customer-office]{\emph{customer office}}} when they are different from the price category of the owner customer, and optionally to {\hyperref[index:term-voip-account]{\emph{VoIP account}}} when they are different from the price category of the owner office. The price categories are obviously specified inside \emph{Parties \(\rightarrow\) Customers / Vendors}, \emph{Parties \(\rightarrow\) Customer Offices}, and \emph{Parties \(\rightarrow\) VoIP Accounts}.


\subsection{Vendor Rates}
\label{index:vendor-rates}
Vendors are typically identified by the \code{dstchannel} field of the {\hyperref[index:term-cdr-table]{\emph{CDR table}}}. This field is set from the Asterisk server and it identifies the channel used to route the call.

If you have different {\hyperref[index:term-voip-vendor]{\emph{VoIP vendors}}}, then you must specify different cost rates, associated to different \code{dstchannels} and {\hyperref[index:term-voip-vendor]{\emph{VoIP vendors}}}.


\subsection{Rates Specified Using CSV Files}
\label{index:rates-specified-using-csv-files}
CSV files are useful for specifying rates associated to {\hyperref[index:term-external-telephone-number]{\emph{external telephone number}}} according their initial prefix. A single CSV file can contain the rating parameters of thousands of telephone prefixes, and it can be managed from Asterisell and from {\hyperref[index:term-asterisell-owner]{\emph{Asterisell owner}}} in a lot more efficient way respect thousands of different rates.

Asterisell is shipped with a rather powerful rate, accepting a CSV file in many configurable formats. If it is not enough, it is possible {\hyperref[index:asterisell-customizations]{\emph{adding custom CSV based rates}}} following the format of the {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}}. This is an example of CSV content:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Afghanistan}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{9375} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Afghanistan}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{9377} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Afghanistan}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{9378} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Afghanistan}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{9379} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Fixed line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Albania}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{355} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Albania}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{35567} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Albania}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{35568} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Albania}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{35569} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Fixed line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Algeria}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{213} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Algeria}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{2136} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Algeria}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{2137} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Algeria}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{2139} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Fixed line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Algeria [Wataniya]}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{2135} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Fixed line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Algeria [Wataniya]}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{21355} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Fixed line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{American Samoa}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{1684} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Fixed line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{American Samoa}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{684} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{American Samoa}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{1684252} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Mobile line}\PYG{l+s}{"} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{American Samoa}\PYG{l+s}{"} \PYG{p}{,}  \PYG{l+m+mi}{1684254} \PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{0.1}\PYG{l+s}{"}
\end{Verbatim}

Up to date, there is no way in Asterisell for retrieving a loaded CSV file, again in his original format. So make sure having a copy somewhere of loaded CSV files.


\subsection{Bundle Rates}
\label{index:bundle-rates}
{\hyperref[index:term-bundle-rate]{\emph{Bundle Rates}}} can be used for specifying things like the minimum income, or line rental costs. They are associated to an invoicing period, and all the CDRs of this period, but not to any CDR in particular.


\section{Invoicing}
\label{index:invoicing}\begin{description}
\item[{Inside {\hyperref[index:main-configurations]{\emph{Main Configurations}}}, set the options:}] \leavevmode\begin{itemize}
\item {} 
\code{invoice\_date\_format}

\item {} 
\code{long\_details\_in\_invoice}

\item {} 
\code{use\_inclusive\_end\_date\_in\_invoice}

\item {} 
\code{currency}

\item {} 
\code{currency\_ascii\_char}

\item {} 
\code{currency\_decimal\_places\_in\_invoices}

\item {} 
\code{culture}

\end{itemize}

\item[{Invoices are generated from the jobs:}] \leavevmode\begin{itemize}
\item {} 
\code{GenerateInvoices}

\item {} 
\code{GenerateInvoiceDetails}

\item {} 
\code{GenerateInvoiceReportAsHTML}

\item {} 
\code{GenerateInvoiceReportAsPDF}

\item {} 
\code{GenerateCallReportAsPDF}

\item {} 
\code{GenerateInvoiceEmail}

\item {} 
\code{SendInvoiceEmails}

\item {} 
\code{SendInvoiceEmail}

\item {} 
\code{SendInvoiceNotificationToAccountant}

\end{itemize}

\end{description}

In case of invoices with a customized layout, you can substitute the job \code{GenerateInvoiceReportAsPDF} with another custom job.

Set {\hyperref[index:asterisell-owner]{\emph{Asterisell Owner Params}}} for setting invoice seller params.

Emails and invoices are generated using the culture specified in \code{apps/asterisell/config/app.yml} file.
\begin{description}
\item[{Emails con be customized replacing the job \code{GenerateInvoiceEmail}, with a custom job:}] \leavevmode\begin{itemize}
\item {} 
a new job like \code{GenerateAcmeInvoiceEmail} must be created;

\item {} 
the job must be added to \code{jobs} list, inside {\hyperref[index:main-configurations]{\emph{Main Configurations}}}, and the old \code{GenerateInvoiceEmail} must be removed;

\end{itemize}

\end{description}


\subsection{Report about Calls}
\label{index:report-about-calls}\begin{description}
\item[{The job \code{GenerateCallReportAsPDF} generates a detailed call report about the type of calls:}] \leavevmode\begin{itemize}
\item {} 
30 Most Expensive Outgoing Calls;

\item {} 
30 Longest Duration Outgoing Calls;

\item {} 
30 Most Frequently Dialled Numbers;

\item {} 
30 Most Expensive Dialled Numbers;

\item {} 
calls ordered by destination type;

\end{itemize}

\end{description}

It can be sent to customers, in order show them how they used your services.


\chapter{Usage}
\label{index:usage}

\section{User Interface}
\label{index:user-interface}

\subsection{Filters}
\label{index:filters}
All textual filters accessible from the administrator, require an ending \code{*}. For example a filter like \code{abc*}, select all the strings having \code{abc} as prefix.

Filters inside {\hyperref[index:term-call-report]{\emph{call report}}} add implicitly the \code{*} character to each search term, in order to simplify its usage for end users.


\subsection{Online Help}
\label{index:online-help}
Read carefully the notes of fields, and the comments at the bottom of each form.


\section{Rating}
\label{index:rating}
Make sure understanding the {\hyperref[index:cdr-rating-process]{\emph{basics of CDRs rating process}}} before defining and changing rates.


\subsection{Error in Rate Configurations}
\label{index:error-in-rate-configurations}
During rating process, Asterisell signals rate errors and conflicts. Rates are usually the most difficult thing to configure in Asterisell, so at least initially, errors are the norm.

Asterisell has a safe approach during rating: a {\hyperref[index:term-cdr]{\emph{CDR}}} is rated only if there is exactly one applicable classification rate, one cost rate, and one income rate, otherwise an error is signaled, and the CDR rating is postponed until rate configurations are fixed. So Asterisell prefers annoying the administrator with error-messages, than silently rating in the wrong way the VoIP calls.

Error notifications contain hints about the solution of the problem, so read them carefully.
\begin{description}
\item[{If properly configured, errors are notified to Asterisell administrator also by email:}] \leavevmode\begin{itemize}
\item {} 
job \code{AdviseAdminOfNewProblems} in {\hyperref[index:main-configurations]{\emph{Main Configurations}}} must be active;

\item {} 
\code{Customers support email, and automatic problem notification email} field in {\hyperref[index:asterisell-owner]{\emph{Asterisell Owner Params}}} must be specified;

\end{itemize}

\end{description}


\subsubsection{Unrated CDRs}
\label{index:unrated-cdrs}
CDRs with problems are not displayed to customers, but they are only visible to administrators in the \emph{Calls \(\rightarrow\) Unprocessed Calls} web form. Note that in this section there are also the few CDRs that were inserted in the CDR table, after the last cron-job processing job. After the next rating process, they will be moved to the {\hyperref[index:term-call-report]{\emph{call report}}}.


\subsubsection{Examples of Problem Solution}
\label{index:examples-of-problem-solution}
An example of error notification:
\begin{quote}

Description: No Rate to apply at date 2011-06-08 of type vendor (calculating a cost) on CDR with id \code{11906}, and destination\_type \code{outgoing} for customer of price category \code{Normal} for external telephone number \code{0033631988888} (with number portability applied it is \code{0033631988888}), and for dstchannel \code{SIP/abcd-12}.

Effect: CDRs in the given rate interval will not be rated.

Suggested Solution: Complete the rate table and wait for the next rate pass. Use menu entry Calls/Unprocessed Calls, for inspecting all details of unprocessed calls.
\end{quote}
\begin{description}
\item[{Its solution:}] \leavevmode\begin{itemize}
\item {} 
check all the active rates of type vendor, active at date 2011-06-08;

\item {} 
check if they are applicable to the telephone number \code{0033631988888}, and price category \code{Normal};

\item {} 
fix the rate for supporting also this type, or add a new rate;

\item {} 
delete the problems from the list;

\item {} 
re-rate old CDRs that can be affected by the changes in rates;

\item {} 
check if the error is signaled again in the error table;

\item {} 
note that errors generated during on-line rerating are not sent to the administrators emails, in order to reducing the number of sent emails during administration and maintenance work.

\end{itemize}

\end{description}


\subsection{CDRs Re-rating}
\label{index:cdr-rerating}\label{index:cdrs-re-rating}\begin{itemize}
\item {} 
open \emph{Calls \(\rightarrow\) Call Report};

\item {} 
select the time frame of CDRs you want re-rate;

\item {} 
note that other filters take no effect during re-rating, only the time-frame criteria;

\item {} 
click on \emph{Re-rate Calls in Time-frame};

\end{itemize}


\subsection{Rates Updating}
\label{index:rates-updating}

\subsubsection{In Advance}
\label{index:in-advance}
If your {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}} communicates you the changes of rates before they take effect, you can create the corresponding new rates, specifying the start date and time. They will be applied only to CDRs after the starting date. You must also set the ending date of current rates, because after the new rates are active, they must be disabled.

This is the best way for updating the rates, because if you rerate CDRs, Asterisell can always apply the correct rate.


\subsubsection{Current}
\label{index:current}
If you update current rates, because there are errors, you must rerate current CDRs, otherwise the modified rates will be applied only to new inserted CDRs. CDRs are rerated {\hyperref[index:cdr-rerating]{\emph{in this way}}}.


\subsubsection{Changing Customer Price Category}
\label{index:changing-customer-price-category}
Up to date customer price category has no start and end date, as in the case of rates. A customer has only one price category, and if you change it, it takes effect immediately. All new CDRs associated to the customer will be calculated according the new price category. If you want apply the price category also to old CDRs, you must rerate them {\hyperref[index:cdr-rerating]{\emph{in this way}}}.

A drawback of this approach it is that if you rerate old CDRs of the customer, they will be rated according the current price category, and not the price category when the CDRs were made. This is obviously a problem in Asterisell specification of price categories. In practice this problem it is not severe, because usually a customer changes his price category at the beginning of the new invoicing period, and rarely CDRs already billed are re-rated. So the typically way for changing price category, is rerating all the CDRs of the current month.


\section{Invoices}
\label{index:invoices}

\subsection{Generation}
\label{index:generation}
\emph{Accounting \(\rightarrow\) Customer Invoices} for generating the invoice of a single customer.

\emph{Accounting \(\rightarrow\) Batch Invoice Creation} for generating all invoices of active customers, of a specific billing period.

\emph{Accounting \(\rightarrow\) Vendor Invoices} for generating the amount you owe to your {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}}, according the costs calculated from Asterisell. The generated pseudo invoices should correspond to the invoices received from vendors.

If you change the cost of calls already invoiced, then the invoice is not updated automatically. You can force a regeneration of an invoice using the \code{Regenerate Invoice button} which is displayed in the edit form of an invoice. It can be used also for batch invoices, and all invoices are simply updated.


\subsection{Sending Emails}
\label{index:sending-emails}
Email is sent only if the \code{Send email to customer} button is pressed and the customer has an associated email.

If there were a problem sending an email, then Asterisell signal the problem, and mark the invoice as not sent.

If SMTP params are left incomplete, then Asterisell will simply not send emails, and it does not consider this an error.

If SMTP params are not correct then Asterisell signal the problem inside problem table.


\chapter{Partners and Resellers}
\label{index:partners-and-resellers}

\section{Resellers}
\label{index:resellers}\label{index:id4}
A {\hyperref[index:term-reseller]{\emph{reseller}}} is a company selling VoIP calls to his customers, and where you play the role of his VoIP vendor.
\begin{description}
\item[{In case of resellers, there are two running instances of Asterisell:}] \leavevmode\begin{itemize}
\item {} 
your main instance;

\item {} 
reseller instance;

\end{itemize}

\item[{A reseller has distinct:}] \leavevmode\begin{itemize}
\item {} 
Asterisell website address;

\item {} 
Asterisell database;

\item {} 
customers;

\item {} 
rates;

\item {} 
invoices;

\end{itemize}

\end{description}

Usually a reseller uses your VoIP servers for managing the calls of his customers, and usually you install the Asterisell reseller instance on the same server of your main instance, but this is not mandatory.


\subsection{License}
\label{index:license}
You need a separate license of Asterisell for each reseller.


\subsection{Main Asterisell Instance Configuration}
\label{index:main-asterisell-instance-configuration}\begin{description}
\item[{In your main Asterisell instance you must:}] \leavevmode\begin{itemize}
\item {} 
make sure that in \emph{always\_scheduled\_jobs} of {\hyperref[index:main-configurations]{\emph{Main Configurations}}}, the job \emph{ExportCDRToReseller} is active.

\item {} 
create a customer for the reseller;

\item {} 
enable the \emph{Is Reseller} flag in the \emph{Parties \(\rightarrow\) Customers / Vendors} form;

\item {} 
configure the \emph{reseller short code};

\end{itemize}

\end{description}

Usually resellers have also a reseller price category.

From now all the CDRs of VoIP accounts associated to the reseller will be exported to CSV files, and put inside the directory \emph{cdr-exported-to-resellers/reseller-short-code}. The directory will be created automatically from Asterisell. The CSV files have name like \emph{cdr-12345678.csv} where \emph{123456789} is a unique and progressive number.

In case of installation of reseller and main instance on the same machine, make sure that the main instance export directory is readable and writable from the cron-job.
\begin{description}
\item[{Supposing your reseller \emph{Gold} has customer \emph{Acme}, with VoIP account \emph{acme001}:}] \leavevmode\begin{itemize}
\item {} 
you must enable VoIP account \emph{acme01} on your VoIP server;

\item {} 
in Asterisell, you must create the VoIP account \emph{acme01} associated to customer \emph{Gold};

\item {} 
you \emph{must not} create customer \emph{Acme} on your Asterisell instance;

\end{itemize}

\end{description}

So you don't know anything about the customers of your reseller, and the applied rates. You only know about the VoIP accounts you manage, and what a reseller must pay you for this service.

Asterisell will produce a unique invoice with all the calls of the VoIP accounts associated to the reseller customer. This is the usual Asterisell work-flow, because a reseller is a normal customer inside Asterisell main instance.


\subsection{Reseller Instance Configuration}
\label{index:reseller-instance-configuration}\begin{itemize}
\item {} 
Install Asterisell for the reseller.

\item {} 
Set \emph{external\_asterisell\_voip\_provider} options inside {\hyperref[index:main-configurations]{\emph{Main Configurations}}}. If the two instances are put on separated computers/network, you must create some script copying new CSV files in the main Asterisell instance, in a local directory of the reseller instance.

\item {} 
Make sure that in \emph{always\_scheduled\_jobs}, the jobs \emph{ImportCDRFromAsterisellProvider} and \emph{CompareProviderCostWithCalculatedCost} are active.

\item {} 
Set vendor rates equal to the rates you apply to reseller on the main Asterisell instance. Note: CDRs imported on the reseller  instance will be checked, and the reseller will be informed if there is some difference between the cost of VoIP calls calculated from main  instance, and the cost calculated from reseller  instance, applying the vendor rates.

\item {} 
Remove all classification rates, and add the \emph{ProcessImportedCDR} classification rate. This rate recognizes CDRs imported from the main Asterisell instance.

\item {} 
Create initial customers, using the same VoIP accounts enabled on the main instance. Note: it is not important activating accounts first on reseller or first on main instance, because data will be not lost in any case.

\end{itemize}

Reseller instance will produce an invoice for each of his customers. This is the normal Asterisell work-flow, because every reseller customer, is a normal customer inside reseller instance.


\subsection{Rerating of CDRs}
\label{index:rerating-of-cdrs}
If already exported CDRs will be rated again on the Asterisell main instance (for example after changing rates, or fixing errors), they will be exported again to the reseller, and reseller instance will update the old CDRs with new values, without creating duplicated/conflicting CDRs.
\begin{description}
\item[{So reseller instance can recognize and manage properly all events like:}] \leavevmode\begin{itemize}
\item {} 
a CDR changed cost/income;

\item {} 
a CDR changed VoIP account;

\item {} 
a CDR changed outgoing/incoming/internal state;

\item {} 
a CDR changed destination/source telephone number;

\item {} 
and so on..;

\end{itemize}

\end{description}

The only exception is in case of CDRs becoming {\hyperref[index:term-ignored-call]{\emph{ignored call}}} on the Asterisell main instance, after they were already sent as a different CDR type. In practice this is not a big problem because rules about CDRs to ignore, rarely change.


\section{Partners}
\label{index:partners}\label{index:id5}
A {\hyperref[index:term-partner]{\emph{partner}}} is another company collaborating with you, that uses your same Asterisell instance, and the same VoIP server.
\begin{description}
\item[{Partners can have distinct:}] \leavevmode\begin{itemize}
\item {} 
customers;

\item {} 
invoices;

\item {} 
login page;

\item {} 
web site logo, header, footer;

\item {} 
rates;

\end{itemize}

\end{description}

All partners have the same administrator privileges on the same Asterisell instance, so they can read and change all the data of other partners.


\subsection{License}
\label{index:id6}
On the contrary of resellers, partners can use both the same Asterisell license, because it is the same Asterisell instance.


\subsection{Configuration}
\label{index:configuration}\begin{itemize}
\item {} 
Create a partner on \emph{Params \(\rightarrow\) Params}.

\item {} 
Associate customers to their partner.

\end{itemize}


\subsection{Invoices}
\label{index:id7}
Each customer invoice will use as seller the corresponding partner.


\subsection{Custom Login Page}
\label{index:custom-login-page}
After login a customer see always the logo, header and footers of his associated partner.

Before login it is not possible, because there is a unique Asterisell web address for each partner. So you must use a common header for all partners.

It is possible creating a custom login page, with a specific address, for each partner.. In \emph{Params \(\rightarrow\) Params} web form, you can specify in \emph{Login URN} a URL-friendly short name for the partner. Then the custom login page with the headers and footers of the partner is accessible on something like \emph{https://www.example.com/partner-name}.


\section{Main Configuration File Content}
\label{index:main-configuration-file-content}\label{index:main-configuration-file}
\code{apps/asterisell/config/app.yml}

\begin{Verbatim}[commandchars=@\[\]]
@# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! @#
@# !!!                                                                           !!! @#
@# !!! I M P O R T A N T:                                                        !!! @#
@# !!!                                                                           !!! @#
@# !!! 1) if you change these values then execute "configure.sh" in order to     !!! @#
@# !!! update the application behaviour;                                         !!! @#
@# !!!                                                                           !!! @#
@# !!! 2) many parameters need a rerate of old calls in order to be propagated   !!! @#
@# !!! also to old calls. When this is the case, it is signaled in the parameter !!! @# 
@# !!! comments as "IMPORTANT"                                                   !!! @#
@# !!!                                                                           !!! @#
@# !!! 3) avoid TABS inside this file, they are not accepted, use only SPACES    !!! @#
@# !!!                                                                           !!! @#
@# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! @#

all:
  available:

    @# The PhpRate class available during the setup of a rate plan.
    @# The class are located in apps/asterisell/lib/ directory.
    @# You can add your own classed.
    @# The format is: 
    @#
    @# @textgreater[] PHP-Class-Name: Rate Description
    @#
    phpRates: 
      PhpCDRProcessing: CDR initial classification
      PhpRateByDuration: By Duration
      PhpRateInCommercialVersion: CSV File with Tel.Prefixes and Rates

    @# These jobs are executed every time the job-queue processor
    @# is invoked. They are indipendent from job-data or events.
    @# They are executed before "available jobs".
    @#
    @# These jobs are processed following the order of declaration.
    @#
    @# These jobs are processed only one time for each activation
    @# of the JobQueueProcessor.
    @#
    @# These jobs are of class FixedJobProcessor.
    @#
    @# NOTE: if one of this jobs fails, then the next job is executed 
    @# in any case.
    @#
    @# IMPORTANT: Changes to this parameter make effect only on new rated calls,
    @# so you must force a rerate if you want apply the new mask only to already
    @# rated calls.
    @#
    always@_scheduled@_jobs:
      - RateCalls
      - CleanCacheFromOldItems              @# maintanance work
      - CheckWebsiteUpdates                 @# check if there are news on Asterisell web-site
      - CheckPartiesWithoutParams           @# maintanance work
      @# - CheckCallCostLimit                @# check if customers have reached theirs call cost limit.
      @# - CheckSafeLimitForConcurrentCalls  @# check if the server has reached his limit about the maximum (safe) number of concurrent calls. In case advise the administrator via mail
      - AdviseAdminOfNewProblems            @# send emails with found problems to administrator


    @# The jobs that are activate when there is a compatible event
    @# on the job queue.
    @#
    @# Jobs are iteratively checked for every initial and new event,
    @# so if a Job fires new events, they can be immediately processed
    @# from other jobs.
    @#
    @# These jobs are of class JobProcessor.
    @#
    @# IMPORTANT: Changes to this parameter make effect only on new rated calls,
    @# so you must force a rerate if you want apply the new mask only to already
    @# rated calls.
    @#
    jobs:
      - WarnCustomerForHighCallCost  @# This job is executed only if it active also the []`CheckCallCostLimit[]` corresponding job. It sends the emails to customers.

  @# Complete only if this Asterisell instance is a reseller of another
  @# Asterisell server acting like a VoIP provider.
  @# 
  @# NOTE: if this is the Asterisell acting like a main VoIP provider, these
  @# settings must be left empty. They must be completed on the reseller side.
  @#
  @# NOTE: these options can be used only for commercial version of Asterisell.
  @#
  external@_asterisell@_voip@_provider:
    - csv@_files@_source@_directory: ""
    - temp@_processing@_csv@_files@_directory: ""
    - processed@_csv@_files@_directory: ""
    - insert@_cdr@_using@_dstchannel: ""

  @# Enable/disable displaying of incoming/incoming/internal 
  @# calls in the customer call report.
  @# This allows to reduce the information overhead.
  @#
  @# This settings influence also INVOICE GENERATION:
  @# if incoming/internal calls are not displayed in the CALL REPORT
  @# then they are not displated / summed up in the invoices,
  @# otherwise they are showed / summed up in the invoices.
  @#
  @# IMPORTANT: if you assign an earn to incoming and internal 
  @# calls, but they are not displayed in the call report,
  @# then these earns are lost because they are not inserted
  @# in the invoices. The underline philosophy of Asterisell
  @# is that you can account to customers only showed costs
  @# in the call report.
  @#
  @# Ignored and Unprocessed calls are not displayed by default.
  @#
  @# The administrator can all these type of calls, 
  @# in any case, indipendently from these settings.
  @#
  @# allowed values: true / false (case sensitive)
  @#
  show@_incoming@_calls: false
  show@_outgoing@_calls: true
  show@_internal@_calls: false
  
  @# Display in the customer call report also 
  @# the direction of the call (incoming/outgoing/internal)
  @# for each call.
  @#
  @# The administrar is not affected from this setting, because 
  @# he sees always the call direction.
  @#
  @# If both incoming and outgoing calls are displayed, the safer
  @# approach is enabling also displying of call direction, otherwise
  @# can be difficult for the end-user, distinguish between the type 
  @# of a call.
  @#
  @# allowed values: true / false (case sensitive)
  @#
  show@_call@_direction: false

  @# Display in the customer call report
  @# also a filter on the call direction (incoming/outgoing/internal).
  @#
  @# This setting influence only the call report
  @# of customer. The administrator can always
  @# filter on call direction.
  @#
  show@_filter@_on@_call@_direction: false

  @# How many calls shows in the call report
  @# containing the list of made calls.
  @# This is the main report of the program.
  @# 
  how@_many@_calls@_in@_call@_report: 30

  @# External telephone number with the specified
  @# prefix are displayed in a short form, without
  @# the prefix.
  @# 
  @# This option is useful when all your customers
  @# reside in the same area. So you can remove 
  @# the standard/default prefix from called numbers
  @# when they are in the standard/default area.
  @#
  @# All other numbers are not modified.
  @# 
  @# In any case, this option does not change the
  @# stored numbers inside the database, only their
  @# visualization.
  @#
  @# Use "-", if you want to disable this feature.
  @#
  @# IMPORTANT: Changes to this parameter make effect only on new rated calls,
  @# so you must force a rerate, if you want apply the new settings
  @# also to already rated calls.
  @#
  not@_displayed@_telephone@_prefix: "-"

  @# Check cost-limits interval expressed in minutes.
  @# Cost-limits check is an heavy operation to do and 
  @# it can be executed after a certain interval of time.
  @# 
  check@_cost@_limits@_after@_minutes: 60

  @# In case the job GenerateMailWarningCustomerForHighCallCost 
  @# is enabled (it is inserted in the list of active jobs), 
  @# this params set how often a customer is warned
  @# about his call cost exceeding his cost limit.
  @#
  @# 0 for disable customer advise (only admin is advised).
  @#
  repeat@_advise@_of@_high@_cost@_limit@_after@_days: 0

  @# How to calculate the max cost limit for each customer.
  @#
  @# "30" for considering the cost of last 30 days.
  @# "m" for considering the current month.
  @# 
  max@_cost@_limit@_timeframe: m

   @# Used from job CheckFrauds (enabled only in commercial version)
   @# The job run according the scheduling of []`check@_cost@_limits@_after@_minutes[]`
   @#
   check@_frauds:
     max@_unprocessed@_calls: 10
     @# if there are more than these unprocessed calls,
     @# then advise the administrator, because there can be unnoticed high calls costs

     compare@_xx@_last@_days@_respect@_customer@_daily@_max@_cost: 5
     @# note: customer daily max cost is the customer monthly max cost, specified in the user interface,
     @# divided by 30. Set to 0 for disabling it.

     compare@_x@_last@_months@_respect@_current@_costs: 3
     @# warn if a customer spent a 25@% more than the maximum cost of last x months in the
     @# same day of week and a comparable hour of the day (hours grouped by 00-06, 06-12, 12-18, 18-24).
     @# Set to 0 for disabling it.

  @# How many concurrent calls, the Asterisk server can support in a safely
  @# manner. If this number of concurrent calls is reached, 
  @# then the administrator is advised.
  @# 
  @# This number depends from the incoming/outgoing bandwidth of the Asterisell
  @# server and from the bandwidth reserved/used from each call/connection.
  @# It is only an indicative/warning value, used for monitoring when
  @# the system reach a warning usage level.
  @# 
  safe@_limit@_for@_concurrent@_calls: 5

  @# The format to use for date/timestamp display in CDR call report.
  @# The format is specified using PHP "date" function format:
  @#    http://www.php.net/manual/en/function.date.php
  @#
  date@_format: "Y/m/d, G:i:s"
    @# "r" for something like "Thu, 21 Dec 2000 16:01:07 +0200"
    @# "c" for something like "2004-02-12T15:19:21+00:00"
    @# "F d, Y G:i:s" for something like "Dec 21, 2000 16:01:07"
    @# "d/m/Y, G:i:s" for italian format

  @# The format to use for date display in Invoices
  @#
  @# IMPORTANT: Changes to this parameter make effect only on new generated invoices.
  @#
  invoice@_date@_format: "Y-m-d"
  @# invoice@_date@_format: "d/m/Y"  for italian format

  @# true for having invoices with details like:
  @# @textgreater[] Italy - Fixed Line        200 calls  ....
  @# @textgreater[] Italy - Mobile Line       100 calls  ...
  @# (grouped by geographi location and type of operator)
  @#
  @# false for having invoices with details like:
  @# @textgreater[] Fixed Line                 200 calls
  @# @textgreater[] Mobile Lines               100 calls
  @# (grouped by type of operator. 
  @#  Maybe you can further create operators like "National Fixed Line", 
  @# "International Fixed Line" and os on...)
  @#
  long@_details@_in@_invoice: true

  @# true for using the last day of the month, in invoices of the month,
  @# like "from 2011-06-01 to 2011-06-30".
  @#
  @# false for using the first day of the next month, in invoices of the month, 
  @# like "from 2011-06-01 to 2011-07-01".
  @# 
  use@_inclusive@_end@_date@_in@_invoice: false

  @# the default currency used for rates, cost and incomes.
  @#
  currency: EUR
  @# currency: USD
  @# currency: AUD

  @# The ASCII char to use for representing the currency
  @# in PDF and textual forms.
  @#
  @# EUR: 128
  @# US: 36
  @# GBP: 163
  @# 
  @# IMPORTANT: Changes to this parameter make effect only on new generated invoices.
  @#
  currency@_ascii@_char: 128

  @# The decimal separator symbol to use in CSV files exported to customers.
  @#
  decimal@_separator@_symbol@_in@_csv: "."

  @# true for exporting numbers like "1.234" in CSV files exported to customers.
  @# false for exporting numbers like 1.234 (without \").
  @#
  @# true is a more safe option of your customers have different locale 
  @# with different types of decimal separator.
  @#
  @# false allows recognizing more easily numbers, during importing of CSV files
  @# inside a spreadsheet.
  @#
  numbers@_as@_strings@_in@_csv: true

  @# The field separator used in CSV files exported to customers.
  @# Normally it is ",".
  @#
  @# If you are using "," also as decimal separator, 
  @# and numbers are not surrounded between \", then use something like ";".
  @#
  csv@_field@_separator: ","

  @# The default culture to use for formatting numbers, dates and so on.
  @# Something like en@_US, it@_IT, ...
  @#
  @# IMPORTANT: if you change this value update also the corresponding
  @# "apps/asterisell/config/settings.yml" file in "prod: default@_culture".
  @# This is not strictly necessary because after login, Asterisell
  @# set the culture of the session to this value, but it is 
  @# a safe setting.
  @#
  @# culture: en@_US
  @# culture: it@_IT
  culture: en@_US

  @# decimal places to use for currency when stored in the database CDR table
  @#
  @# IMPORTANT: if you change this value then force a re-rate of all calls
  @# because already rated calls will be in an inconsisten format.
  @#
  currency@_decimal@_places: 4

  @# decimal places to use for each currency in an invoice
  @#
  @# IMPORTANT: Changes to this parameter make effect only on new generated invoices.
  @#
  @# IMPORTANT: this parameter is also used for rounding
  @# costs/incomes in CALL REPORT. Supposing 2 decimal places,
  @# a cost like "0.005" is rounded to "0.01".
  @# 
  currency@_decimal@_places@_in@_invoices: 2

  @# If these field is an empty list (@PYGZlb[]@PYGZrb[]) then "cdr.dst" field is the destination
  @# telephone number of the call.
  @#
  @# If the value of this setting is a list then
  @# cdr.lastdata field is the destination telephone number of the call.
  @# For each billable call, "cdr.lastapp" must be a value inside the list, 
  @# otherwise the call is not rated and the problem 
  @# is signaled to the administrator. 
  @# 
  @# IMPORTANT: Changes to this parameter make effect only on new rated calls,
  @# so you must force a rerate if you want apply the new mask only to already
  @# rated calls.
  @# 
  lastapp@_accepted@_values: @PYGZlb[]@PYGZrb[]

  @# The internal telephone number is the VoIP account code,
  @# managed from the Asterisk server.
  @#
  @# The external telephone number is the number residing on 
  @# external lines, reachable using the services of the
  @# VoIP service provider.
  @#
  @# In an outgoing call, the internal telephone number is the source of the call.
  @# In an incoming call, the internal telephone number is the destination of the call.
  @#
  @# In an outgoing call, the external telephone number is the destination of the call.
  @# In an incoming call, the external telephone number is the source of the call.
  @#
  @# Asterisell displays in CALL REPORT something like:
  @#
  @# @textgreater[] @textbar[] INTERNAL VoIP Account @textbar[] Call Direction @textbar[] EXTERNAL Telephone Number @textbar[]
  @# @textgreater[] +-----------------------+----------------+---------------------------+
  @# @textgreater[] @textbar[] account123            @textbar[]    outgoing    @textbar[] 390423XXXX                @textbar[]
  @# @textgreater[] @textbar[] account123            @textbar[]    incoming    @textbar[] 39343XXXXX                @textbar[]
  @#
  @# so the distinction is between internal and external telephone number
  @# and not between call source and destination.
  @# The same distinction is done also in the rate forms.
  @#
  @# The problem is: what fields of the CDR record must Asterisell 
  @# use for displaying in the call report the internal and external telephone number?
  @#
  @# Available options:
  @# * 0: use "accountcode" field as internal telephone number (display in CALL REPORT the account-code name),
  @#      use "dst/lastapp@_accepted@_values" field as external telephone number.
  @# * 1: use "src" field as internal telephone number only for outgoing calls, 
  @#      use "src" field as external telephone number only for incoming calls,
  @#      use "dst/lastapp@_accepted@_values" as external telephone number only for outgoing calls,
  @#      use "dst/lastapp@_accepted@_values" as internal telephone number only for incoming calls.
  @#      in case of unprocessed/ignored/internal use always "src" field for internal calls.
  @# * 2: use "src" field as internal telephone number,
  @#      use "dst/lastapp@_accepted@_values" field as external telephone number.
  @#      in case of unprocessed/ignored/internal use always "src" field for internal calls.
  @# * 3: it is assigned from the CDRInitialProcessing rate, that must complete during initial processing of a rate,
  @#      these fields:
  @#        - []`cdr.ar@_asterisk@_account@_id[]` (null if it is missing, and RateProcess will inform the user of the error);
  @#        - []`cdr.cached@_internal@_telephone@_number[]`;
  @#        - []`cdr.cached@_external@_telephone@_number[]`;
  @#        - []`cdr.cached@_masked@_external@_telephone@_number[]`, can be null (it is completed from the framework), or with an explicit value
  @#        - []`cdr.ar@_telephone@_prefix.id[]` can be null (it is completed from the framework),
  @#           or with an explicit value, in this case number portability is not automatically transferred to the telephone prefix,
  @#           and it must be explicitely managed from the CDR processor;
  @#      See []`apps/asterisell/lib/rates/CustomCDRProcessing.php[]` for a template of associated processing rate.
  @#      A rate like the proposed example must be added to the rate table.
  @# * 4: use "accountcode" field as internal telephone number (display in CALL REPORT the account-code name),
  @#      use "dst" as external telephone number for outgoing and internal calls,
  @#      use "src" as external telephone number for incoming calls.
  @# IMPORTANT: Changes to this parameter make effect only on new rated calls,
  @# so you must force a rerate if you want apply the new mask only to already
  @# rated calls.
  @# 
  internal@_external@_telephone@_numbers: 0

  @# An external telephone number can be masked in the CALL REPORT view,
  @# for privacy reasons.
  @#
  @# This parameter identifies the number of last digits to mask in the
  @# external telephone number.
  @#
  @# A typical value is 3 digits to mask, in order to obtain something
  @# like "39059567XXX".
  @#
  @# 0 stays for no number masking.
  @#
  @# Internal calls (in the case they are displayed in the
  @# CALL REPORT), between two VoIP accounts are no masked.
  @#
  @# Unprocessed calls are never masked, but they are viewable
  @# only from the administrator.
  @#
  @# IMPORTANT: Changes to this parameter make effect only on new rated calls,
  @# so you must force a rerate if you want apply the new mask only to already
  @# rated calls.
  @# 
  @# IMPORTANT: Changes to this parameter make effect only on new rated calls,
  @# so you must force a rerate if you want apply the new mask only to already
  @# rated calls.
  @# 
  mask@_for@_external@_telephone@_number: 3

  @# Remove a log message from the Job Log Table 
  @# when it is older than this number of months.
  @#
  months@_after@_removing@_a@_job@_log@_entry: 2

  @# Where uploaded files are put/read.
  @# This is a directory inside "web" directory,
  @# and it must be web-server readable and writable.
  @#
  @# This default directory is already created.
  @# If you set up a new directory, you must manually
  @# create it.
  @#
  sfMediaLibrary:
    upload@_dir: uploads/assets
\end{Verbatim}


\chapter{Glossary}
\label{index:glossary}\begin{description}

\index{Asterisell owner}\item[{Asterisell owner}] \leavevmode\phantomsection\label{index:term-asterisell-owner}
You: a company selling VoIP services to his {\hyperref[index:term-customer]{\emph{customers}}}. It uses one or more {\hyperref[index:term-voip-vendor]{\emph{VoIP vendors}}}, and it can have optionally one or more {\hyperref[index:term-partner]{\emph{partners}}}.


\index{bundle rate}\item[{bundle rate}] \leavevmode\phantomsection\label{index:term-bundle-rate}
A rate associated to the set of CDRs of the invoicing period, as the minimum income, or line rentals.


\index{call report}\item[{call report}] \leavevmode\phantomsection\label{index:term-call-report}
The web page displaying all the VoIP calls, and related data to administrator or to end users. It displays specialized information according the type of logged user.


\index{CDR}\item[{CDR}] \leavevmode\phantomsection\label{index:term-cdr}
A call detail record of the {\hyperref[index:term-cdr-table]{\emph{CDR table}}}, containing all the details of a VoIP call.


\index{CDR table}\item[{CDR table}] \leavevmode\phantomsection\label{index:term-cdr-table}
A MySQL table where the VoIP server put details about the VoIP calls.


\index{classification rate}\item[{classification rate}] \leavevmode\phantomsection\label{index:term-classification-rate}
A rate that classifies the {\hyperref[index:term-cdr]{\emph{CDR}}} as {\hyperref[index:term-outgoing-call]{\emph{outgoing call}}}, or {\hyperref[index:term-incoming-call]{\emph{incoming call}}}, or {\hyperref[index:term-internal-call]{\emph{internal call}}}, or {\hyperref[index:term-ignored-call]{\emph{ignored call}}}.


\index{cost rate}\item[{cost rate}] \leavevmode\phantomsection\label{index:term-cost-rate}
A rate that assigns the cost of the {\hyperref[index:term-cdr]{\emph{CDR}}}, that is what you (the {\hyperref[index:term-asterisell-owner]{\emph{Asterisell owner}}}) must pay to another {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}} for routing the calls.


\index{customer}\item[{customer}] \leavevmode\phantomsection\label{index:term-customer}
A party that uses the services of {\hyperref[index:term-asterisell-owner]{\emph{Asterisell owner}}} for making VoIP calls. He can have one or more {\hyperref[index:term-customer-office]{\emph{customer offices}}}.


\index{customer office}\item[{customer office}] \leavevmode\phantomsection\label{index:term-customer-office}
It identifies distinct physical locations, or distinct business units, of a {\hyperref[index:term-customer]{\emph{customer}}}. It can have one or more {\hyperref[index:term-voip-account]{\emph{VoIP accounts}}}.


\index{external telephone number}\item[{external telephone number}] \leavevmode\phantomsection\label{index:term-external-telephone-number}
It is the number residing on external lines, reachable using the services of the {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}}. In case of {\hyperref[index:term-outgoing-call]{\emph{outgoing call}}}, it is the destination of the call. In case of {\hyperref[index:term-incoming-call]{\emph{incoming call}}}, it is the source of the call.


\index{ignored call}\item[{ignored call}] \leavevmode\phantomsection\label{index:term-ignored-call}
A call that has no income, cost, and that is not displayed in the {\hyperref[index:term-call-report]{\emph{call report}}}. It can be completely ignored.


\index{income rate}\item[{income rate}] \leavevmode\phantomsection\label{index:term-income-rate}
A rate that assigns the income of the {\hyperref[index:term-cdr]{\emph{CDR}}}, that is what the {\hyperref[index:term-customer]{\emph{customer}}} must pay for it.


\index{incoming call}\item[{incoming call}] \leavevmode\phantomsection\label{index:term-incoming-call}
A call coming from a telephone network not directly managed from you, and having one of your customer {\hyperref[index:term-voip-account]{\emph{VoIP account}}} as destination.


\index{internal call}\item[{internal call}] \leavevmode\phantomsection\label{index:term-internal-call}
A call inside a telephone network directly managed from you. The call source and destination are usually both associated to your customers.


\index{internal telephone number}\item[{internal telephone number}] \leavevmode\phantomsection\label{index:term-internal-telephone-number}
It is the {\hyperref[index:term-voip-account]{\emph{VoIP account}}} code. In case of {\hyperref[index:term-outgoing-call]{\emph{outgoing call}}}, it is the source of the call. In case of {\hyperref[index:term-incoming-call]{\emph{incoming call}}}, it is the destination of the call.


\index{outgoing call}\item[{outgoing call}] \leavevmode\phantomsection\label{index:term-outgoing-call}
A call directed to a telephone network not directly managed from you, and having one of your customer {\hyperref[index:term-voip-account]{\emph{VoIP account}}} as source of the call.


\index{partner}\item[{partner}] \leavevmode\phantomsection\label{index:term-partner}
A Partner is a company collaborating with you, that uses your same Asterisell instance for selling VoIP calls to his customers.


\index{reseller}\item[{reseller}] \leavevmode\phantomsection\label{index:term-reseller}
A Reseller is a company selling VoIP calls to his customers, and where you play the role of his {\hyperref[index:term-voip-vendor]{\emph{VoIP vendor}}}.


\index{VoIP account}\item[{VoIP account}] \leavevmode\phantomsection\label{index:term-voip-account}
A VoIP internal telephone number managed from the Asterisk server.
It is an internal account code. Usually Asterisk VoIP server put it on the \code{accountcode} field of the {\hyperref[index:term-cdr-table]{\emph{CDR table}}}.
Note: the Asterisk standard documentation pretends that this code is specified on a per-channel basis, but this is not the case in Asterisell configuration. So each accountcode has the same associated customer for every channel. This is also useful/practical in case of the same customer using different channels.


\index{VoIP vendor}\item[{VoIP vendor}] \leavevmode\phantomsection\label{index:term-voip-vendor}
A company that can route VoIP calls to destination end-points, typically traditional telephone networks. It is used from the {\hyperref[index:term-asterisell-owner]{\emph{Asterisell owner}}} for routing the VoIP calls.

\end{description}



\renewcommand{\indexname}{Index}
\printindex
\end{document}
