

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Asterisell Overview &mdash; Asterisell documentation</title>
    <link rel="stylesheet" href="_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     'asterisell-free-stable-3.13.00
',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/asterisell_favicon.ico"/>
    <link rel="top" title="Asterisell documentation" href="#" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="#">Asterisell documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
<div class="section" id="asterisell-overview">
<h1>Asterisell Overview<a class="headerlink" href="#asterisell-overview" title="Permalink to this headline">¶</a></h1>
<p>Asterisell is a web application for rating, showing to customers, and billing VoIP calls.</p>
<dl class="docutils">
<dt>Usage scenario:</dt>
<dd><ul class="first last simple">
<li>you are a vendor of Voice over IP Telephony (VoIP) services;</li>
<li>your <a class="reference internal" href="#term-customer"><em class="xref std std-term">customers</em></a> pay you for this service;</li>
<li>your customers can call users residing on telephone networks that are not directly managed/owned from you;</li>
<li>for routing calls to external networks, you use the services of other <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">telephone vendors</em></a>, and you pay them for this service;</li>
</ul>
</dd>
<dt>Every call has:</dt>
<dd><ul class="first last simple">
<li>an income: what your <a class="reference internal" href="#term-customer"><em class="xref std std-term">customer</em></a> pays to you;</li>
<li>a cost: what you pay to other telephone service vendors (<a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a>) in order to route the call;</li>
<li>an earn: the difference between the income and the cost;</li>
</ul>
</dd>
<dt>You can use Asterisell for:</dt>
<dd><ul class="first last simple">
<li>rating calls;</li>
<li>showing to your customers details about their calls;</li>
<li>billing your customers;</li>
<li>calculating what you owe to other telephone service vendors (<a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a>)</li>
</ul>
</dd>
</dl>
<p>You can have different <a class="reference internal" href="#term-partner"><em class="xref std std-term">partners</em></a>, and different <a class="reference internal" href="#term-reseller"><em class="xref std std-term">resellers</em></a>.</p>
</div>
<div class="section" id="installation">
<span id="id1"></span><h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>HTTP WEB Server;</li>
<li>PHP 5.0 or greater (PHP 4.0 is not supported);</li>
<li><a class="reference external" href="http://www.php.net/manual/en/image.installation.php">GD support</a> enabled in PHP;</li>
<li>MySQL DBMS;</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="software-infrastructure">
<h2>Software Infrastructure<a class="headerlink" href="#software-infrastructure" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>VoIP calls are managed usually from an <a class="reference external" href="http://www.asterisk.org">Asterisk Server</a></dt>
<dd><ul class="first last simple">
<li>it routes the calls to the proper dial peer;</li>
<li>it associates to every customer a unique &#8220;accountcode&#8221;;</li>
<li>it writes Call Detail Records (CDRs) on a specific MySQL database table shared with Asterisell.</li>
</ul>
</dd>
</dl>
<p>VoIP calls can be managed from other servers, or call detail records can be imported from CSV files.</p>
<dl class="docutils">
<dt>Asterisell is a PHP5 web application that:</dt>
<dd><ul class="first last simple">
<li>reads calls information from the CDR table shared with Asterisk Server;</li>
<li>associate to every call a cost (what the service provider pays to other vendors for routing the customer&#8217;s call);</li>
<li>associate to every call an income (what the customer pays to the service provider);</li>
<li>displays calls info;</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="download">
<h2>Download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>The suggested way to download this release is using <a class="reference external" href="http://git-scm.com/">Git version control system</a> . This allows to:</dt>
<dd><ul class="first last simple">
<li>download application updates in an efficient way;</li>
<li>be advised of conflicts between your customization and application updates;</li>
<li>send back to me bug-fixes and improvements;</li>
<li>receive improvements from other in an efficient way;</li>
<li>upgrade to commercial release easily without loosing your customization&#8217;s;</li>
</ul>
</dd>
</dl>
<p>There is an Asterisell repository at <a class="reference external" href="http://github.com/massimo-zaniboni/Asterisell">http://github.com/massimo-zaniboni/Asterisell.</a></p>
<p>Choose a directory where installing Asterisell. For example <cite>/var/www/asterisell3</cite>.</p>
<p>For initial download of the free version:</p>
<div class="highlight-python"><pre>git clone http://github.com/massimo-zaniboni/Asterisell.git</pre>
</div>
<p>For the commercial version:</p>
<div class="highlight-python"><pre>git clone http://your-license:your-license@support.asterisell.com/asterisell/git/asterisell-commercial-stable-3.git &lt;your-new-asterisell-directory&gt;</pre>
</div>
<p>replacing <cite>your-license</cite> with your license code, obtained after purchasing the commercial version. NOTE: the download operation is rather slow (1-8 minutes).</p>
<p>It is always possible upgrading a free version to a commercial version. For updating/upgrading to new releases see <a class="reference internal" href="#upgrading"><em>Upgrading</em></a>.</p>
<div class="section" id="file-permissions">
<h3>File Permissions<a class="headerlink" href="#file-permissions" title="Permalink to this headline">¶</a></h3>
<p>Make sure that the <a class="reference internal" href="#term-web-server-user"><em class="xref std std-term">Web Server User</em></a> can read the content of the installation directory. Execute something like:</p>
<div class="highlight-python"><pre>chown -R :www-data asterisell3
chmod -R g+rwx asterisell3</pre>
</div>
<p>where <cite>www-data</cite> must be replaced with the correct <a class="reference internal" href="#term-web-server-user"><em class="xref std std-term">Web Server User</em></a>.</p>
</div>
<div class="section" id="packages">
<h3>Packages<a class="headerlink" href="#packages" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>The typical installation requires:</dt>
<dd><ul class="first last simple">
<li>Apache2 HTTP server</li>
<li>mod_php5</li>
<li>mod_ssl</li>
<li>MySQL database server</li>
<li>awk</li>
</ul>
</dd>
</dl>
<p>Asterisell use some PHP5 libraries. On Fedora/Centos for example you must install:</p>
<div class="highlight-python"><pre>yum install awk
yum install httpd
yum install php php-cli php-common
yum install mysql mysql-server php-mysql
yum install php-bcmath php-xml php-mbstring</pre>
</div>
<p>and then execute:</p>
<div class="highlight-python"><pre>/etc/init.d/httpd restart</pre>
</div>
</div>
</div>
<div class="section" id="mysql-database-configuration">
<h2>MySQL Database Configuration<a class="headerlink" href="#mysql-database-configuration" title="Permalink to this headline">¶</a></h2>
<p>Up to date Asterisell supports only <a class="reference external" href="http://www.mysql.com">MySQL DBMS</a>.</p>
<div class="section" id="database-access-parameters">
<h3>Database Access Parameters<a class="headerlink" href="#database-access-parameters" title="Permalink to this headline">¶</a></h3>
<p>Update:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">config</span><span class="o">/</span><span class="n">databases</span><span class="o">.</span><span class="n">yml</span>
<span class="n">config</span><span class="o">/</span><span class="n">propel</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>according your needs using the correct host, username and password for MySQL access.</p>
<p>Initially you must use the root/admin account of MySQL, because  configuration scripts will create a new database. Later you can create a specific user for the Asterisell database, in order to limit the capability of the Asterisell user.</p>
<p>The suggested database name is <cite>asterisell3</cite> in order to avoid conflicts with previous or new version of Asterisell needing different database schema.</p>
</div>
<div class="section" id="how-to-create-a-database-user-with-limited-access-to-asterisell-database">
<h3>How to create a Database User with Limited Access to Asterisell Database<a class="headerlink" href="#how-to-create-a-database-user-with-limited-access-to-asterisell-database" title="Permalink to this headline">¶</a></h3>
<p>Enter into MySQL shell:</p>
<div class="highlight-python"><pre>mysql -u root -p mysql</pre>
</div>
<p>Create a user that can invoke MySQL only from localhost (supposing that Asterisell web-server hosts also the MySQL DBMS):</p>
<div class="highlight-python"><pre>CREATE USER 'asterisell3user'@'localhost' IDENTIFIED BY 'some-password-here';
GRANT ALL ON asterisell3.* TO 'asterisell3user'@'localhost';</pre>
</div>
<p>This example, supposes that <cite>asterisell3</cite> is the name of created Asterisell database, and <cite>asterisell3user</cite> the name of database user.</p>
<p>NOTE: <cite>GRANT ALL</cite> is needed in order to support the database upgrade script.</p>
</div>
<div class="section" id="installation-script">
<h3>Installation Script<a class="headerlink" href="#installation-script" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>The installation script will:</dt>
<dd><ul class="first last simple">
<li>create a new <cite>asterisell3</cite> database;</li>
<li>load the tables;</li>
<li>initializing the Asterisell application with demo data;</li>
<li>fix directory permissions;</li>
<li>reset the Symfony cache;</li>
</ul>
</dd>
</dl>
<p>It must not be used if it is an upgrade of Asterisell, because otherwise all data will be lost. In any case the script will warn you about this.</p>
<p>First edit <cite>apps/asterisell/confip/app.yml</cite>, and associate to <cite>web_server_user</cite> the correct <a class="reference internal" href="#term-web-server-user"><em class="xref std std-term">Web Server User</em></a>.</p>
<p>Then execute:</p>
<div class="highlight-python"><pre>php asterisell.php activate
php asterisell.php install</pre>
</div>
</div>
<div class="section" id="change-demo-data-later">
<h3>Change Demo Data Later<a class="headerlink" href="#change-demo-data-later" title="Permalink to this headline">¶</a></h3>
<p>The installation script will load also some demo data in order to test Asterisell.</p>
<p>If you want later, start with an empty database, you must execute:</p>
<div class="highlight-python"><pre>php asterisell.php data init &lt;some-password-for-root-user-access&gt;</pre>
</div>
<p>for creating a database, with only minimal data, and a &#8220;root&#8221; user with the chosen password for initial login. Then you can start inserting real data inside this database.</p>
<p>The initialization script supports other type of data initialization. For a complete list of supported commands:</p>
<div class="highlight-python"><pre>php asterisell.php help</pre>
</div>
</div>
<div class="section" id="mysql-advanced-optimizations">
<h3>MySQL advanced optimizations<a class="headerlink" href="#mysql-advanced-optimizations" title="Permalink to this headline">¶</a></h3>
<p>For obtaining a 10x-20x speedup of call-report and related queries, the CDRs of last 1-2 months must be saved in the MySQL database cache in RAM. This makes a big difference in performances. Make sure having a <cite>my.cnf</cite> file like this:</p>
<div class="highlight-python"><pre>[mysqld]
###############################
# ASTERISELL RELATED SETTINGS #
###############################
# Optimize InnoDB performances for Asterisell usage.
# NOTE: it will use the majority of the RAM of the server
# for Asterisell and other MySQL databases.
#
# Set this to 60-80% the RAM of the server
innodb_buffer_pool_size = 1G

sort_buffer_size = 50M
thread_cache_size = 4
tmp_table_size = 50M
sync_binlog = 0

# not very important
innodb_additional_mem_pool_size = 10M

# Commits are flushed on the disk each second,
# and not immediately.
innodb_flush_log_at_trx_commit = 0

innodb_lock_wait_timeout = 50
table_cache = 92
innodb_flush_method=O_DIRECT

# speed-up rating of CDRs and also other performances - very important
innodb_log_buffer_size = 8M</pre>
</div>
<p>Restart MySQL for enabling changes in configuration.</p>
</div>
<div class="section" id="optional-configuration-for-developers">
<h3>Optional Configuration for Developers<a class="headerlink" href="#optional-configuration-for-developers" title="Permalink to this headline">¶</a></h3>
<p>If you are a developer, and you are changing Asterisell source code, maybe you want to change also its database schema, contained in <cite>config/schema.yml</cite>.</p>
<p>In this case, you must also instruct <cite>config/propel.ini</cite> about how to access the MySQL database. These are the same parameters of <cite>config/databases.yml</cite>, but they are used from a different tool, and so they must be repeated here.</p>
<p>Update <cite>config/propel.ini</cite> according your needs.</p>
<p>Adapt it, using the same parameters of the <cite>databases.yml</cite>. This file contains a lot of parameters, but you must only change these lines:</p>
<div class="highlight-python"><pre>propel.database.createUrl  = mysql://localhost/
propel.database.url        = mysql://localhost/asterisell3
propel.output.dir          = /var/www/asterisell3</pre>
</div>
<p>If you have changed the database structure in the file <cite>config/schema.yml</cite>, you must also update the SQL instructions creating the MySQL database. You can use the script <cite>scripts/makedb.sh</cite>. It will recreate the SQL commands, then call <strong class="command">php asterisell.php init &lt;some-root-password&gt;</strong> in order to load the new database. You can also extend <cite>asterisell.php</cite> upgrade procedure <cite>upgradeDatabase</cite> with new database upgrade commands, for upgrading live instances of Asterisell.</p>
</div>
</div>
<div class="section" id="web-server">
<h2>Web Server<a class="headerlink" href="#web-server" title="Permalink to this headline">¶</a></h2>
<div class="section" id="website-configuration">
<h3>Website Configuration<a class="headerlink" href="#website-configuration" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>Create the file <cite>asterisell.conf</cite> inside the directory:</dt>
<dd><ul class="first last simple">
<li><cite>/etc/httpd/conf.d/</cite> or</li>
<li><cite>/etc/apache2/conf.d/</cite></li>
</ul>
</dd>
</dl>
<p>The content is something like:</p>
<div class="highlight-python"><pre>Alias /your-voip-service /var/www/asterisell3/web/

&lt;Location /your-voip-service&gt;
  Order allow,deny
  Allow from all

  # If you have mod_ssl installed
  # then with these lines you can force the usage of https connections
  # for all Asterisell access.
  # If you omit them, then the passwords are sent in plain text and
  # they can be intercepted from hackers...
  #
  AllowOverride All
  &lt;IfModule mod_rewrite.c&gt;
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
  &lt;/IfModule&gt;

&lt;/Location&gt;</pre>
</div>
<p>NOTE: remember to add <cite>/web</cite> to your Asterisell installation directory. This because it is only the <cite>web</cite> sub-directory of Asterisell project that must be part of the web-space.</p>
<p>Restart the apache2 httpd server in order to render active the configurations using a command like:</p>
<div class="highlight-python"><pre>/etc/init.d/httpd restart</pre>
</div>
<p>or:</p>
<div class="highlight-python"><pre>/etc/init.d/apache2 restart</pre>
</div>
<p>If it is all correct then <cite>http://your-voip-service</cite> will display the login form.</p>
</div>
<div class="section" id="php-resources">
<h3>PHP Resources<a class="headerlink" href="#php-resources" title="Permalink to this headline">¶</a></h3>
<p>The administrator can invoke heavy jobs, for example graph and stats about calls. In this case it is useful to increase the resources of PHP scripts inside on-line sessions.</p>
<p>In CENTOS the settings are in <cite>/etc/php.ini</cite>, in Debian are in <cite>/etc/php5/apache2/php.ini</cite>. Change something like:</p>
<div class="highlight-python"><pre>;;;;;;;;;;;;;;;;;;;
; Resource Limits ;
;;;;;;;;;;;;;;;;;;;

max_execution_time = 30     ; Maximum execution time of each script, in seconds
max_input_time = 60 ; Maximum amount of time each script may spend parsing request data
;max_input_nesting_level = 64 ; Maximum input variable nesting level
memory_limit = 128M      ; Maximum amount of memory a script may consume (128MB)</pre>
</div>
<p>into something like:</p>
<div class="highlight-python"><pre>;;;;;;;;;;;;;;;;;;;
; Resource Limits ;
;;;;;;;;;;;;;;;;;;;

max_execution_time = 180     ; Maximum execution time of each script, in seconds
max_input_time = 60 ; Maximum amount of time each script may spend parsing request data
;max_input_nesting_level = 64 ; Maximum input variable nesting level
memory_limit = 128M      ; Maximum amount of memory a script may consume (128MB)</pre>
</div>
<p>increasing the execution time from 30 seconds to 180 seconds.</p>
<p>NOTE: heavy jobs like email sending, are done from the cron-job, in off-line mode, and they are not affected from these settings / constraints.</p>
</div>
<div class="section" id="php-speedup">
<h3>PHP Speedup<a class="headerlink" href="#php-speedup" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://pecl.php.net/package/APC">APC</a> is a free, open source framework that caches data and compiled code from the PHP byte-code compiler in shared memory.</p>
<p>I suggest installing it, because it is well tested, and it speeds-up a lot the execution of Asterisell and other PHP applications.</p>
<p>For installing it in Debian:</p>
<div class="highlight-python"><pre>aptitude install php-apc</pre>
</div>
<p>or in CENTOS follow <a class="reference external" href="http://2bits.com/articles/installing-php-apc-gnulinux-centos-5.html">the instruction of this webpage</a> (up to date the APC package is not part of CENTOS).</p>
<p>IMPORTANT: In order to activate it, the Apache web server must be restarted.</p>
<p>IMPORTANT: Up to date there can be conflicts between APC (version 3.0.19) and SwiftMailer. If after the sending of the first Asterisell mail, an error message appears in the problem table (something like <cite>Fatal error: Cannot inherit previously-inherited or override constant LEVEL_TOP from interface Swift_Mime_Message</cite>), then try to upgrade APC or deactivated APC.</p>
</div>
<div class="section" id="mysql">
<h3>MySQL<a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h3>
<p>Rates based on CSV files can be rather big, because they contain a lot of data. Asterisell save them in a record, and the SQL command can be rather big.</p>
<p>So you must use a reasonable <cite>max_allowed_packet</cite> size, for communication between PHP and MySQL.</p>
<p>Check that inside <cite>/etc/mysql/my.cnf</cite> there is something like:</p>
<div class="highlight-python"><pre>[mysqld]
max_allowed_packet = 16M</pre>
</div>
<p>In case of problems, increase this limit, and then restart MySQL (NOTE: during restart new inserted CDR records will be lost):</p>
<div class="highlight-python"><pre>/etc/init.d/mysql restart</pre>
</div>
<p>Last versions of MySQL execute a fsync (flush) on disk for every transaction. This is a very big slow down for Asterisell, because it does not group batch work on CDRs on a single transaction. If MySQL is slow, it can be configured for flushing on disk the transactions every seconds. Add inside <cite>/etc/mysql/my.cnf</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">innodb_flush_log_at_trx_commit</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Consult <a class="reference external" href="http://dev.mysql.com/doc/refman/4.1/en/innodb-parameters.html#sysvar_innodb_flush_log_at_trx_commit">MySQL related documentation</a> for more details on side effects of this setting.</p>
</div>
</div>
<div class="section" id="cron-job">
<h2>Cron Job<a class="headerlink" href="#cron-job" title="Permalink to this headline">¶</a></h2>
<div class="section" id="calls-rating-and-jobs-processing">
<h3>Calls Rating and Jobs Processing<a class="headerlink" href="#calls-rating-and-jobs-processing" title="Permalink to this headline">¶</a></h3>
<p>Asterisell rates the calls and execute other jobs off-line, using a cron-job process. This allows to use all the resources of the machine, without the constraints of online sessions.</p>
<p>The list of jobs to execute and the various parameters are inside <cite>apps/asterisell/config/app.yml</cite>.</p>
<p>In case of problems during job execution, a mail is sent to the administrator.</p>
</div>
<div class="section" id="user-permissions">
<h3>User Permissions<a class="headerlink" href="#user-permissions" title="Permalink to this headline">¶</a></h3>
<p>The process must be executed from the same <a class="reference internal" href="#term-web-server-user"><em class="xref std std-term">Web Server User</em></a> that is associated to the http connection.</p>
</div>
<div class="section" id="cron-job-setting">
<h3>Cron Job Setting<a class="headerlink" href="#cron-job-setting" title="Permalink to this headline">¶</a></h3>
<p>Supposing the <a class="reference internal" href="#term-web-server-user"><em class="xref std std-term">Web Server User</em></a> is <cite>apache</cite> you can associate to it a cron job using the command:</p>
<div class="highlight-python"><pre>crontab -u apache -e</pre>
</div>
<p>This command will open an editor. If the defalt editor is <cite>vi</cite>, then digit <cite>:i</cite> (and press enter) in order to start editing, and <cite>:wq</cite> (and press enter) at the end of editing, in order to <cite>write</cite> and <cite>quit/exit</cite> from the editor</p>
<p>Add this line:</p>
<div class="highlight-python"><pre>5,10,15,20,25,30,35,40,45,50,55 * * * * sh -c "cd /your-asterisell-dir/scripts/ ; nice php process_jobs.php &gt; /dev/null "</pre>
</div>
<p>The meaning of the line is to execute at minutes 5, 10, 15, 20, ... of every hour the job processing command inside the Asterisell directory.</p>
</div>
<div class="section" id="log-rotate">
<h3>Log Rotate<a class="headerlink" href="#log-rotate" title="Permalink to this headline">¶</a></h3>
<p>In order to reduce log file size put <cite>asterisell-logrotate</cite> with execution privileges in <cite>/etc/cron.monthly</cite> directory:</p>
<div class="highlight-python"><pre>#!/bin/sh
cd /your-asterisell-install-dir
./symfony log-rotate asterisell prod</pre>
</div>
<p>and set it as an executable file</p>
<div class="highlight-python"><pre>chmod u+x asterisell-logrotate</pre>
</div>
<p>Note that <cite>asterisell</cite> after <cite>symfony</cite> command is the name of the application and it is not depends from the directory installation.</p>
</div>
</div>
<div class="section" id="asterisell-customizations">
<span id="id2"></span><h2>Asterisell Customizations<a class="headerlink" href="#asterisell-customizations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="jobs-workflow-customizations">
<h3>Jobs/Workflow Customizations<a class="headerlink" href="#jobs-workflow-customizations" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>Asterisell uses a blackboard approach to process information:</dt>
<dd><ul class="first last simple">
<li>events are put inside the database/blackboard;</li>
<li>customizable/configurable jobs react to events;</li>
<li>jobs can produce new events;</li>
</ul>
</dd>
</dl>
<p>In this way it is possible to add new jobs, changing the behaviour of the application.</p>
<p>If you add new <cite>jobs</cite> make sure to add them to the <cite>apps/asterisell/lib/jobs/userjobs</cite>, otherwise during subsequent update of Asterisell application, all new jobs could be lost or there can be a lot of Git merge conflicts.</p>
<p>Some Jobs like PDF invoicing, email composition and so on require some customization. You can create a custom Job modifying already existing jobs, put them in <cite>apps/asterisell/lib/jobs/userjobs</cite> directory. The more elegant way is to change also the name of the job, add it to the <cite>apps/asterisell/config/app.yml</cite> file, removing the old job.</p>
</div>
<div class="section" id="rates-customizations">
<h3>Rates Customizations<a class="headerlink" href="#rates-customizations" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>New type of rate methods can be added:</dt>
<dd><ul class="first last simple">
<li>add a new rate inside <cite>apps/asterisell/lib/rates</cite></li>
<li>enable the rate inside <cite>apps/asterisell/config/app.yml</cite></li>
<li>refresh the cache <strong class="command">php asterisell.php activate</strong></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>File Permissions<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="section" id="log-directory">
<h4>Log Directory<a class="headerlink" href="#log-directory" title="Permalink to this headline">¶</a></h4>
<p>Often after upgrades there are problems related to the Asterisell log files inside log directory.</p>
<p>If this file was created from root then the <a class="reference internal" href="#term-web-server-user"><em class="xref std std-term">Web Server User</em></a> is not able to add info to it and the entire Asterisell application is blocked. In this case change the permissions of file with something like:</p>
<div class="highlight-python"><pre>cd log
chmod a+rw asterisell_prod.log
chmod a+rw asterisell_dev.log</pre>
</div>
<p>or execute:</p>
<div class="highlight-python"><pre>./symfony fix-perms</pre>
</div>
<p>Try also to restart the web server.</p>
</div>
<div class="section" id="created-files">
<h4>Created Files<a class="headerlink" href="#created-files" title="Permalink to this headline">¶</a></h4>
<p>During initial Asterisell configuration, and upgrade new files can be created. In this case they can be not readable from <a class="reference internal" href="#term-web-server-user"><em class="xref std std-term">Web Server User</em></a>. In this case perform a:</p>
<div class="highlight-python"><pre>php asterisell activate</pre>
</div>
<p>with super user access (maybe <cite>sudo php asterisell activate</cite>), for applying the correct ownership to files.</p>
</div>
</div>
<div class="section" id="additional-run-time-debug-info">
<h3>Additional Run-Time Debug Info<a class="headerlink" href="#additional-run-time-debug-info" title="Permalink to this headline">¶</a></h3>
<p>In case of problems you can enable the development/debug version of Asterisell that shows useful information about its execution and related problems. Execute:</p>
<div class="highlight-python"><pre>./symfony enable asterisell dev</pre>
</div>
<p>and open the url <cite>http://your-web-url/asterisell_dev.php/login</cite></p>
<p>When finished remember to execute:</p>
<div class="highlight-python"><pre>./symfony disable asterisell dev</pre>
</div>
<p>NOTE: on the contrary of Asterisell production version, in the development version if you change Asterisell source code, you must not execute <strong class="command">php asterisell.php activate</strong>, because the development version recreate all files every time in order to speed up development at the expense of run-time executions.</p>
<p>NOTE: as in the Asterisell product version, in the development version if you change some configuration parameters you must execute <strong class="command">php asterisell.php activate</strong> because certain Asterisell modules are regenerated according the configured values.</p>
</div>
<div class="section" id="run-time-configuration-problems">
<h3>Run Time Configuration Problems<a class="headerlink" href="#run-time-configuration-problems" title="Permalink to this headline">¶</a></h3>
<p>Every problem encountered from Asterisell during the call rating process is clearly reported to the administrator with hints of how to resolve it.</p>
<p>The presence of problems is signaled also via email to the administrator.</p>
<p>In case of dubious configurations Asterisell advise the administrator and suspend the rate of affected calls.</p>
<dl class="docutils">
<dt>The rate process is rather robust and error-free regarding ill defined configurations because:</dt>
<dd><ul class="first last simple">
<li>re-rating of calls is always possible;</li>
<li>problems are always signaled;</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="feedback">
<h3>Feedback<a class="headerlink" href="#feedback" title="Permalink to this headline">¶</a></h3>
<p>Web servers, PHP environment, libraries, and so on... can interact in strange ways. If something is not working properly let me know!</p>
</div>
</div>
<div class="section" id="security">
<h2>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h2>
<p>The end user interacts only with the <cite>Call Report</cite> form. The content of user input fields is checked by a very conservative function that removes every non proper character.</p>
<p>No particular care is put on other forms because they are accessible only from the administrator.</p>
<p>User session handling is managed directly from Symfony and PHP engine.</p>
</div>
</div>
<div class="section" id="upgrading">
<span id="id4"></span><h1>Upgrading<a class="headerlink" href="#upgrading" title="Permalink to this headline">¶</a></h1>
<div class="section" id="migrating-from-free-to-commercial-version">
<h2>Migrating from Free to Commercial Version<a class="headerlink" href="#migrating-from-free-to-commercial-version" title="Permalink to this headline">¶</a></h2>
<p>Inside <cite>apps/asterisell/config/app.yml</cite>, change:</p>
<div class="highlight-python"><pre>git_upgrade_command: git pull https://github.com/massimo-zaniboni/Asterisell</pre>
</div>
<p>into:</p>
<div class="highlight-python"><pre>git_upgrade_command: git pull http://your-license:your-license@support.asterisell.com/asterisell/git/asterisell-commercial-stable-3.git`</pre>
</div>
<p>where <cite>your-license</cite>, must be replaced with your license code, obtained after purchasing the commercial version.</p>
<p>Then make effective this change with:</p>
<div class="highlight-python"><pre>php asterisell.php activate</pre>
</div>
<p>From now you will use the commercial version as source of upgrades. The next passages are the same of normal upgrades.</p>
</div>
<div class="section" id="procedure-outline">
<h2>Procedure Outline<a class="headerlink" href="#procedure-outline" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>These are the steps performed in a partially automatic way from the procedure:</dt>
<dd><ul class="first last simple">
<li>Disable cron job processing.</li>
<li>Disable access of normal users to the application.</li>
<li>Inform users that the system is in maintenance mode.</li>
<li>Merge updates of Asterisell application, with your customizations using Git.</li>
<li>Upgrade the database.</li>
<li>Test the application as administrator.</li>
<li>Enable cron job processing, and access of normal users.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="merge-your-customizations-with-new-asterisell-version">
<h2>Merge your customizations with new Asterisell version<a class="headerlink" href="#merge-your-customizations-with-new-asterisell-version" title="Permalink to this headline">¶</a></h2>
<p>Before upgrading the source code you must save your local changes (customizations) inside local Git repository:</p>
<div class="highlight-python"><pre>git commit -a -m "&lt;DESCRIBE YOUR CUSTOM CHANGES&gt;"</pre>
</div>
<p>You can also see the current un-versioned files with:</p>
<div class="highlight-python"><pre>git status</pre>
</div>
<p>and add files to ignore editing the file <cite>.gitignore</cite>, or add files to the repository with:</p>
<div class="highlight-python"><pre>git add &lt;file-name&gt;</pre>
</div>
<p>Now you are ready for starting the source code upgrading/merging phase, with:</p>
<div class="highlight-python"><pre>php asterisell.php app upgrade</pre>
</div>
<dl class="docutils">
<dt>This command will:</dt>
<dd><ul class="first last simple">
<li>lock the cron job processor;</li>
<li>avoid the usage of application from normal users, informing them that the application is in maintenance mode;</li>
<li>execute the merge/upgrade command;</li>
</ul>
</dd>
<dt>There can be merge conflicts, between upstream changes and your local changes. You must resolve them, using the standard Git approach:</dt>
<dd><ul class="first last simple">
<li><strong class="command">git status</strong> shows the files with conflicts;</li>
<li>edit the files with problems,</li>
<li>fix the <cite>&gt;&gt;&gt;&gt;&gt;&gt; .... &lt;&lt;&lt;&lt;&lt;&lt;&lt;</cite> sections,</li>
<li>signal to git that the conflict on the file is resolved using <strong class="command">git add &lt;fixed-file&gt;</strong>,</li>
<li>check pending conflicts with <strong class="command">git status</strong>,</li>
<li>commit the final merged version when done with <strong class="command">git commit -a</strong></li>
</ul>
</dd>
</dl>
<p>In case of troubles, <a class="reference external" href=":http://groups.google.it/group/asterisell">ask to the forum.</a> I will update these installation notes, according the signaled problems/suggestions.</p>
<p>When conflicts are resolved you can upgrade the database, with:</p>
<div class="highlight-python"><pre>php asterisell.php data upgrade</pre>
</div>
<dl class="docutils">
<dt>This command will:</dt>
<dd><ul class="first last simple">
<li>ask for making an optional backup of your data;</li>
<li>upgrade the database;</li>
</ul>
</dd>
</dl>
<p>You should test the behaviour of the application as administrator.</p>
<p>Then you must enable cron job processing:</p>
<div class="highlight-python"><pre>php asterisell.php cron enable</pre>
</div>
<p>and user access to the application:</p>
<div class="highlight-python"><pre>php asterisell.php app enable</pre>
</div>
</div>
<div class="section" id="code-refresh">
<h2>Code refresh<a class="headerlink" href="#code-refresh" title="Permalink to this headline">¶</a></h2>
<p>After changing some code, for example after resolving merging conflicts, or after applying customization, you <em>must execute</em>:</p>
<div class="highlight-python"><pre>php asterisell.php activate</pre>
</div>
<p>in order to flush the Symfony cache and fix the permission on <cite>log</cite> and <cite>cache</cite> directories, and for generating some PHP files depending from application settings.</p>
<p>This command is automatically called form upgrade procedure.</p>
</div>
<div class="section" id="reducing-application-downtime">
<h2>Reducing Application Downtime<a class="headerlink" href="#reducing-application-downtime" title="Permalink to this headline">¶</a></h2>
<p>You can create a deploy directory, where merging the code and resolving related conflicts, in order to reduce the downtime of the application in the production environment.</p>
<blockquote>
<div><ul class="simple">
<li>Commit all the changes in current production environment to Git repo (<strong class="command">git commit -a</strong>).</li>
<li><strong class="command">git clone &lt;production-repo&gt; &lt;testing-repo&gt;</strong> for cloning the current production repo to a testing repo.</li>
<li><strong class="command">cd &lt;testing-repo&gt;</strong></li>
<li>Follow the source code upgrade process, without upgrading the database.</li>
<li><strong class="command">cd &lt;production-repo&gt;</strong></li>
<li>Inside <cite>apps/asterisell/config/app.yml</cite>, set the option <cite>git_upgrade_command</cite> to the path of the testing repo. In this way you will upgrade the code in production repo, using a repo with all the merge problems fixed, reducing the down-time.</li>
<li>Follow the upgrade process. Upgrade also the database.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="testing-environment-with-a-testing-database">
<h2>Testing Environment With a Testing Database<a class="headerlink" href="#testing-environment-with-a-testing-database" title="Permalink to this headline">¶</a></h2>
<p>You can create a testing environment specifying a distinct database inside <cite>config/databases.yml</cite> options. In this way you can have a full testing environment where you can test the application before deploying it.</p>
<p>When you upgrade the production environment, make sure that the source code upgrade process does not change the name of the production database with the name of the testing database, inside <cite>config/databases.yml</cite> file.</p>
</div>
</div>
<div class="section" id="configurations">
<h1>Configurations<a class="headerlink" href="#configurations" title="Permalink to this headline">¶</a></h1>
<div class="section" id="main-configurations">
<span id="id5"></span><h2>Main Configurations<a class="headerlink" href="#main-configurations" title="Permalink to this headline">¶</a></h2>
<p><tt class="file docutils literal"><span class="pre">apps/asterisell/config/app.yml</span></tt> contains the main configurations of Asterisell. Once they are properly configured, they rarely change.</p>
<p>The meaning of various settings are explained directly inside the file comments. Details of some settings will be explained in other tasks. Initially set only parameters of witch you are sure, leaving default values otherwise.</p>
<p>In order to make active the changes, you must execute <strong class="command">php asterisell.php activate</strong>.</p>
<p><a class="reference internal" href="#main-configuration-file"><em>Main Configuration File Content</em></a>.</p>
</div>
<div class="section" id="asterisell-owner-params">
<span id="asterisell-owner"></span><h2>Asterisell Owner Params<a class="headerlink" href="#asterisell-owner-params" title="Permalink to this headline">¶</a></h2>
<p>Use <em class="menuselection">Params ‣ Params ‣ Default</em> for defining the params of <a class="reference internal" href="#term-asterisell-owner"><em class="xref std std-term">Asterisell owner</em></a>.</p>
</div>
<div class="section" id="web-site-appearances">
<h2>Web Site Appearances<a class="headerlink" href="#web-site-appearances" title="Permalink to this headline">¶</a></h2>
<p>Logo, slogan, title, footer and similar aspects of the web-site can be customized directly from <a class="reference internal" href="#asterisell-owner"><em>Asterisell Owner Params</em></a>.</p>
<p>Web Site appearance can be further customized changing <cite>apps/asterisell/templates/asterisell_layout.php</cite> and <cite>web/css</cite> content.</p>
</div>
<div class="section" id="vendors-specification">
<span id="id6"></span><h2>Vendors Specification<a class="headerlink" href="#vendors-specification" title="Permalink to this headline">¶</a></h2>
<p>Use <em class="menuselection">Parties ‣ Customers / Vendors</em> for defining a <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a>.</p>
<p>Use <em class="menuselection">Rates</em> for creating rates associated to the <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a>, calculating the cost of calls.</p>
<p>You can define one or more vendors, and you can use different vendors for different calls, associating cost rates to corresponding VoIP vendor.</p>
</div>
<div class="section" id="customers-specification">
<h2>Customers Specification<a class="headerlink" href="#customers-specification" title="Permalink to this headline">¶</a></h2>
<p>Use <em class="menuselection">Parties ‣ Customers / Vendors</em> for defining a <a class="reference internal" href="#term-customer"><em class="xref std std-term">customer</em></a>.</p>
<p>Use <em class="menuselection">Parties ‣ Customer Offices</em> for defining one or more  <a class="reference internal" href="#term-customer-office"><em class="xref std std-term">customer office</em></a> associated to a customer.</p>
<p>Use <em class="menuselection">Parties ‣ VoIP Accounts</em> for defining one or more  <a class="reference internal" href="#term-voip-account"><em class="xref std std-term">VoIP account</em></a>, associated to an office.</p>
<p>The <a class="reference internal" href="#term-call-report"><em class="xref std std-term">call report</em></a> will display office and account information only when they are relevant. They are not displayed in case of logged customers with only one office, or only one VoIP account.</p>
<p>If a customer is not more active, disable the <tt class="docutils literal"><span class="pre">Is</span> <span class="pre">Active</span></tt> flag. Invoices associated to the customer will not generated.</p>
</div>
<div class="section" id="telephone-prefixes-in-call-report">
<span id="telephone-prefixes"></span><h2>Telephone Prefixes in Call Report<a class="headerlink" href="#telephone-prefixes-in-call-report" title="Permalink to this headline">¶</a></h2>
<p>The call report contains something like</p>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="28%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Tel.Tr.</th>
<th class="head">Location</th>
<th class="head">Connection</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>3932894234XXX
1707782466XXX</td>
<td>Italy
USA</td>
<td>Mobile Line
Fixed Line</td>
</tr>
</tbody>
</table>
<p>The table associates a <cite>location</cite> and a <cite>connection type</cite> to a telephone number.</p>
<dl class="docutils">
<dt>This association is done inspecting the <em class="menuselection">Params ‣ Telephone Prefixes</em> table:</dt>
<dd><ul class="first last simple">
<li>A prefix like &#8220;39&#8221; can be associated to a generic &#8220;Italian Operator&#8221;.</li>
<li>A prefix like &#8220;393&#8221; can be associated to a generic (but more specific) &#8220;Mobile Italian Operator&#8221;.</li>
<li>A prefix like &#8220;39328&#8221; can be associated to the specific &#8220;Wind Mobile Italian Operator&#8221;.</li>
<li>A telephone number is associated to its more specific prefix. So &#8220;3944444&#8221; is associated to &#8220;Italian Operator&#8221;, while &#8220;39344444&#8221; to &#8220;Mobile Italian Operator&#8221; and finally &#8220;393284444&#8221; to &#8220;Wind Mobile Italian Operator&#8221;.</li>
</ul>
</dd>
</dl>
<p>CDRs must be rerated again, in order to see the effects of changes in the table.</p>
<p>Telephone Prefix table is not used in rating process, but only in call report.</p>
<p>Initial Asterisell installation already load a complete list of standard world-wide prefixes. You can manually add custom prefixes associated to your specific settings.</p>
<dl class="docutils">
<dt>The table can be completed also importing from a CSV file:</dt>
<dd><ul class="first last simple">
<li><em class="menuselection">Params ‣ Rates</em>.</li>
<li>Create a pseudo rate of type <cite>CSV File with Tel.Prefixes and Rates</cite>.</li>
<li>Set the rate according the format of the CSV file.</li>
<li>Make sure activating <cite>Update also prefix table</cite>.</li>
<li>Press <cite>Save</cite> button.</li>
<li>Note that in default settings, local numbers are stored internally in their complete form with the international prefix. Make sure that it is part of the table.</li>
<li>Delete the rate.</li>
<li>Check the prefix table.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="rates">
<span id="cdr-rating-process"></span><h2>Rates<a class="headerlink" href="#rates" title="Permalink to this headline">¶</a></h2>
<p>Rates classify every <a class="reference internal" href="#term-cdr"><em class="xref std std-term">CDR</em></a>, and associate a cost and an income to them.</p>
<div class="section" id="classification-rates">
<h3>Classification Rates<a class="headerlink" href="#classification-rates" title="Permalink to this headline">¶</a></h3>
<p>A new <a class="reference internal" href="#term-cdr"><em class="xref std std-term">CDR</em></a> starts with state unprocessed, and they are initially managed from <a class="reference internal" href="#term-classification-rate"><em class="xref std std-term">classification rate</em></a>. They inspect mainly the amaflags and disposition fields where Asterisk server put billing hints/information.</p>
<dl class="docutils">
<dt>A classification rate classifies a call:</dt>
<dd><ul class="first last simple">
<li>as <tt class="docutils literal"><span class="pre">outgoing</span></tt>, if the call is made from the customer to an external telephone number;</li>
<li>as <tt class="docutils literal"><span class="pre">incoming</span></tt>, it the call is from an external telephone number to the customer VoIP number;</li>
<li>as <tt class="docutils literal"><span class="pre">internal</span></tt>, if the call is made from the customer to an internal VoIP account;</li>
<li>as <tt class="docutils literal"><span class="pre">ignore</span></tt>, if the CDR can be ignored;</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="telephone-number-normalizations">
<h3>Telephone Number Normalizations<a class="headerlink" href="#telephone-number-normalizations" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>Advanced CDR processing can be performed from customized <tt class="docutils literal"><span class="pre">classification</span> <span class="pre">rates</span></tt>, that are usually created from developers according the specific needs of Asterisell instance. Some example of doable operations are:</dt>
<dd><ul class="first last simple">
<li>recognition of complex patterns for local/mobile/interstate/intrastate telephone numbers;</li>
<li>ad-hoc formatting of telephone numbers according their type;</li>
<li>recognition of off-peak, peak or week-end calls, according the call-time;</li>
</ul>
</dd>
</dl>
<p>These operations are performed by custom PHP code, so you must consult Asterisell assistance and support.</p>
</div>
<div class="section" id="ignored-cdrs">
<h3>Ignored CDRs<a class="headerlink" href="#ignored-cdrs" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>CDRs of type <tt class="docutils literal"><span class="pre">ignore</span></tt> are not further processed:</dt>
<dd><ul class="first last simple">
<li>they are not displayed in the <a class="reference internal" href="#term-call-report"><em class="xref std std-term">call report</em></a>;</li>
<li>they are not billed;</li>
<li>their fields can be in a bad format;</li>
</ul>
</dd>
</dl>
<p>They remain in the <a class="reference internal" href="#term-cdr-table"><em class="xref std std-term">CDR table</em></a>, but they are ignored.</p>
<p>Note that they are not deleted, and in case of change of the classification rate, usually during initial phase of Asterisell customized deployment, the ignored CDRs can be re-rated as all other CDRs, and in case they can become CDRs of other type, if the classification logic is changed.</p>
</div>
<div class="section" id="internal-cdrs">
<h3>Internal CDRs<a class="headerlink" href="#internal-cdrs" title="Permalink to this headline">¶</a></h3>
<p>CDRs of type <tt class="docutils literal"><span class="pre">internal</span></tt> are calls between two local VoIP users.</p>
<p>Usually they have no cost, so they are usually associated to rates saying their cost and income is simply 0.</p>
<p>They can be displayed or not displayed in the <a class="reference internal" href="#term-call-report"><em class="xref std std-term">call report</em></a>, according the setting <tt class="docutils literal"><span class="pre">show_internal_calls</span></tt> in <a class="reference internal" href="#main-configurations"><em>Main Configurations</em></a>. If they are not displayed in the call report, then they are also ignored during the invoice phase. The administrator views always all the type of calls, except ignored calls, because he must have a complete vision of CDR table content.</p>
</div>
<div class="section" id="incoming-calls">
<h3>Incoming Calls<a class="headerlink" href="#incoming-calls" title="Permalink to this headline">¶</a></h3>
<p>Incoming calls usually have no cost, so they are usually associated to rates saying their cost and income is simply 0.</p>
<p>They can be displayed or not displayed in the <a class="reference internal" href="#term-call-report"><em class="xref std std-term">call report</em></a>, according the setting <tt class="docutils literal"><span class="pre">show_incoming_calls</span></tt> in <a class="reference internal" href="#main-configurations"><em>Main Configurations</em></a>. If they are not displayed in the call report, then they are also ignored during the invoice phase. The administrator views always all the type of calls, except ignored calls, because he must have a complete vision of CDR table content.</p>
</div>
<div class="section" id="revenue-sharing">
<h3>Revenue Sharing<a class="headerlink" href="#revenue-sharing" title="Permalink to this headline">¶</a></h3>
<p>A call can have a negative cost. In this case you (as <a class="reference internal" href="#term-asterisell-owner"><em class="xref std std-term">Asterisell owner</em></a>) are earning something for the call. There can be a revenue sharing between the <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a> and you (as <a class="reference internal" href="#term-asterisell-owner"><em class="xref std std-term">Asterisell owner</em></a>). This can be the case for incoming calls for mobile telephone numbers.</p>
<p>A call can have a negative income. In this case there can be a revenue sharing between your customer and you.</p>
<p>Separate invoices can be created for revenue sharing, setting the <tt class="docutils literal"><span class="pre">Is</span> <span class="pre">Revenue</span> <span class="pre">Sharing</span></tt> field, during invoice generation. All the CDRs with negative incomes are part of revenue sharing invoices.</p>
</div>
<div class="section" id="normal-rates">
<h3>Normal Rates<a class="headerlink" href="#normal-rates" title="Permalink to this headline">¶</a></h3>
<p>CDRs of type <tt class="docutils literal"><span class="pre">outgoing</span></tt>, <tt class="docutils literal"><span class="pre">incoming</span></tt>, <tt class="docutils literal"><span class="pre">internal</span></tt> are processed from <tt class="docutils literal"><span class="pre">normal</span> <span class="pre">rates</span></tt>, for determining their cost and income.</p>
<p>Income rates are associated to the customers of a specific price category.</p>
<p>Cost rates are associated to a specific <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a>.</p>
</div>
<div class="section" id="rate-priorities">
<h3>Rate Priorities<a class="headerlink" href="#rate-priorities" title="Permalink to this headline">¶</a></h3>
<p>There can be one or more rates applicable to a CDR. It is always used the most specific rate. When there are doubts about which is the most specific rate, an error is generated, and the CDR remains unprocessed.</p>
<p>Every rate have a priority method. Two rates are comparable if they have the same priority method. If there are two rates applicable to the same CDR, but with two different priority method, an error is generated, because there is no way for determining what is the most specific rate.</p>
<p>Usually classification rates use destination channel as priority method, and normal rates the <a class="reference internal" href="#term-external-telephone-number"><em class="xref std std-term">external telephone number</em></a>.</p>
<dl class="docutils">
<dt>For example given:</dt>
<dd><ul class="first last simple">
<li>a rate <tt class="docutils literal"><span class="pre">A</span></tt> with the <a class="reference internal" href="#term-external-telephone-number"><em class="xref std std-term">external telephone number</em></a> priority method, matching numbers like <tt class="docutils literal"><span class="pre">123</span></tt>;</li>
<li>a rate <tt class="docutils literal"><span class="pre">B</span></tt> matching numbers like <tt class="docutils literal"><span class="pre">1234</span></tt>;</li>
<li>a telephone number <tt class="docutils literal"><span class="pre">AA</span></tt> like <tt class="docutils literal"><span class="pre">12355555</span></tt>;</li>
<li>a telephone number <tt class="docutils literal"><span class="pre">BB</span></tt> like <tt class="docutils literal"><span class="pre">12344444</span></tt>;</li>
</ul>
</dd>
</dl>
<p>then the rate <tt class="docutils literal"><span class="pre">A</span></tt> is the best match for <tt class="docutils literal"><span class="pre">AA</span></tt>, while <tt class="docutils literal"><span class="pre">B</span></tt> is the best match for <tt class="docutils literal"><span class="pre">BB</span></tt>.</p>
<p>A rate can have the <tt class="docutils literal"><span class="pre">exception</span></tt> field activated. They have a greater priority respect no exception rates. The most specific exception is selected, if there is any. This allows creating special rating rules, having priority methods different from other normal rates.</p>
</div>
<div class="section" id="price-categories">
<h3>Price Categories<a class="headerlink" href="#price-categories" title="Permalink to this headline">¶</a></h3>
<p>Income rates have a price category. They are applicable only to customers of the same price category. Example of price categories can be <tt class="docutils literal"><span class="pre">normal</span></tt>, <tt class="docutils literal"><span class="pre">discounted</span></tt>, <tt class="docutils literal"><span class="pre">reseller</span></tt>.</p>
<p>Price categories must be assigned to every <a class="reference internal" href="#term-customer"><em class="xref std std-term">customer</em></a>, and optionally to <a class="reference internal" href="#term-customer-office"><em class="xref std std-term">customer office</em></a> when they are different from the price category of the owner customer, and optionally to <a class="reference internal" href="#term-voip-account"><em class="xref std std-term">VoIP account</em></a> when they are different from the price category of the owner office. The price categories are obviously specified inside <em class="menuselection">Parties ‣ Customers / Vendors</em>, <em class="menuselection">Parties ‣ Customer Offices</em>, and <em class="menuselection">Parties ‣ VoIP Accounts</em>.</p>
</div>
<div class="section" id="vendor-rates">
<h3>Vendor Rates<a class="headerlink" href="#vendor-rates" title="Permalink to this headline">¶</a></h3>
<p>Vendors are typically identified by the <tt class="docutils literal"><span class="pre">dstchannel</span></tt> field of the <a class="reference internal" href="#term-cdr-table"><em class="xref std std-term">CDR table</em></a>. This field is set from the Asterisk server and it identifies the channel used to route the call.</p>
<p>If you have different <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendors</em></a>, then you must specify different cost rates, associated to different <tt class="docutils literal"><span class="pre">dstchannels</span></tt> and <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendors</em></a>.</p>
</div>
<div class="section" id="rates-specified-using-csv-files">
<h3>Rates Specified Using CSV Files<a class="headerlink" href="#rates-specified-using-csv-files" title="Permalink to this headline">¶</a></h3>
<p>CSV files are useful for specifying rates associated to <a class="reference internal" href="#term-external-telephone-number"><em class="xref std std-term">external telephone number</em></a> according their initial prefix. A single CSV file can contain the rating parameters of thousands of telephone prefixes, and it can be managed from Asterisell and from <a class="reference internal" href="#term-asterisell-owner"><em class="xref std std-term">Asterisell owner</em></a> in a lot more efficient way respect thousands of different rates.</p>
<p>Asterisell is shipped with a rather powerful rate, accepting a CSV file in many configurable formats. If it is not enough, it is possible <a class="reference internal" href="#asterisell-customizations"><em>adding custom CSV based rates</em></a> following the format of the <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a>. This is an example of CSV content:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Afghanistan&quot;</span> <span class="p">,</span>  <span class="mi">9375</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Afghanistan&quot;</span> <span class="p">,</span>  <span class="mi">9377</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Afghanistan&quot;</span> <span class="p">,</span>  <span class="mi">9378</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Afghanistan&quot;</span> <span class="p">,</span>  <span class="mi">9379</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Fixed line&quot;</span> <span class="p">,</span> <span class="s">&quot;Albania&quot;</span> <span class="p">,</span>  <span class="mi">355</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Albania&quot;</span> <span class="p">,</span>  <span class="mi">35567</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Albania&quot;</span> <span class="p">,</span>  <span class="mi">35568</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Albania&quot;</span> <span class="p">,</span>  <span class="mi">35569</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Fixed line&quot;</span> <span class="p">,</span> <span class="s">&quot;Algeria&quot;</span> <span class="p">,</span>  <span class="mi">213</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Algeria&quot;</span> <span class="p">,</span>  <span class="mi">2136</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Algeria&quot;</span> <span class="p">,</span>  <span class="mi">2137</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;Algeria&quot;</span> <span class="p">,</span>  <span class="mi">2139</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Fixed line&quot;</span> <span class="p">,</span> <span class="s">&quot;Algeria [Wataniya]&quot;</span> <span class="p">,</span>  <span class="mi">2135</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Fixed line&quot;</span> <span class="p">,</span> <span class="s">&quot;Algeria [Wataniya]&quot;</span> <span class="p">,</span>  <span class="mi">21355</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Fixed line&quot;</span> <span class="p">,</span> <span class="s">&quot;American Samoa&quot;</span> <span class="p">,</span>  <span class="mi">1684</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Fixed line&quot;</span> <span class="p">,</span> <span class="s">&quot;American Samoa&quot;</span> <span class="p">,</span>  <span class="mi">684</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;American Samoa&quot;</span> <span class="p">,</span>  <span class="mi">1684252</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Mobile line&quot;</span> <span class="p">,</span> <span class="s">&quot;American Samoa&quot;</span> <span class="p">,</span>  <span class="mi">1684254</span> <span class="p">,</span> <span class="s">&quot;0.1&quot;</span>
</pre></div>
</div>
<p>Up to date, there is no way in Asterisell for retrieving a loaded CSV file, again in his original format. So make sure having a copy somewhere of loaded CSV files.</p>
</div>
<div class="section" id="bundle-rates">
<h3>Bundle Rates<a class="headerlink" href="#bundle-rates" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#term-bundle-rate"><em class="xref std std-term">Bundle Rates</em></a> can be used for specifying things like the minimum income, or line rental costs. They are associated to an invoicing period, and all the CDRs of this period, but not to any CDR in particular.</p>
</div>
</div>
<div class="section" id="invoicing">
<h2>Invoicing<a class="headerlink" href="#invoicing" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Inside <a class="reference internal" href="#main-configurations"><em>Main Configurations</em></a>, set the options:</dt>
<dd><ul class="first last simple">
<li><tt class="docutils literal"><span class="pre">invoice_date_format</span></tt></li>
<li><tt class="docutils literal"><span class="pre">long_details_in_invoice</span></tt></li>
<li><tt class="docutils literal"><span class="pre">use_inclusive_end_date_in_invoice</span></tt></li>
<li><tt class="docutils literal"><span class="pre">currency</span></tt></li>
<li><tt class="docutils literal"><span class="pre">currency_ascii_char</span></tt></li>
<li><tt class="docutils literal"><span class="pre">currency_decimal_places_in_invoices</span></tt></li>
<li><tt class="docutils literal"><span class="pre">culture</span></tt></li>
</ul>
</dd>
<dt>Invoices are generated from the jobs:</dt>
<dd><ul class="first last simple">
<li><tt class="docutils literal"><span class="pre">GenerateInvoices</span></tt></li>
<li><tt class="docutils literal"><span class="pre">GenerateInvoiceDetails</span></tt></li>
<li><tt class="docutils literal"><span class="pre">GenerateInvoiceReportAsHTML</span></tt></li>
<li><tt class="docutils literal"><span class="pre">GenerateInvoiceReportAsPDF</span></tt></li>
<li><tt class="docutils literal"><span class="pre">GenerateCallReportAsPDF</span></tt></li>
<li><tt class="docutils literal"><span class="pre">GenerateInvoiceEmail</span></tt></li>
<li><tt class="docutils literal"><span class="pre">SendInvoiceEmails</span></tt></li>
<li><tt class="docutils literal"><span class="pre">SendInvoiceEmail</span></tt></li>
<li><tt class="docutils literal"><span class="pre">SendInvoiceNotificationToAccountant</span></tt></li>
</ul>
</dd>
</dl>
<p>In case of invoices with a customized layout, you can substitute the job <tt class="docutils literal"><span class="pre">GenerateInvoiceReportAsPDF</span></tt> with another custom job.</p>
<p>Set <a class="reference internal" href="#asterisell-owner"><em>Asterisell Owner Params</em></a> for setting invoice seller params.</p>
<p>Emails and invoices are generated using the culture specified in <tt class="docutils literal"><span class="pre">apps/asterisell/config/app.yml</span></tt> file.</p>
<dl class="docutils">
<dt>Emails con be customized replacing the job <tt class="docutils literal"><span class="pre">GenerateInvoiceEmail</span></tt>, with a custom job:</dt>
<dd><ul class="first last simple">
<li>a new job like <tt class="docutils literal"><span class="pre">GenerateAcmeInvoiceEmail</span></tt> must be created;</li>
<li>the job must be added to <tt class="docutils literal"><span class="pre">jobs</span></tt> list, inside <a class="reference internal" href="#main-configurations"><em>Main Configurations</em></a>, and the old <tt class="docutils literal"><span class="pre">GenerateInvoiceEmail</span></tt> must be removed;</li>
</ul>
</dd>
</dl>
<div class="section" id="report-about-calls">
<h3>Report about Calls<a class="headerlink" href="#report-about-calls" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>The job <tt class="docutils literal"><span class="pre">GenerateCallReportAsPDF</span></tt> generates a detailed call report about the type of calls:</dt>
<dd><ul class="first last simple">
<li>30 Most Expensive Outgoing Calls;</li>
<li>30 Longest Duration Outgoing Calls;</li>
<li>30 Most Frequently Dialled Numbers;</li>
<li>30 Most Expensive Dialled Numbers;</li>
<li>calls ordered by destination type;</li>
</ul>
</dd>
</dl>
<p>It can be sent to customers, in order show them how they used your services.</p>
</div>
</div>
</div>
<div class="section" id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<div class="section" id="user-interface">
<h2>User Interface<a class="headerlink" href="#user-interface" title="Permalink to this headline">¶</a></h2>
<div class="section" id="filters">
<h3>Filters<a class="headerlink" href="#filters" title="Permalink to this headline">¶</a></h3>
<p>All textual filters accessible from the administrator, require an ending <tt class="docutils literal"><span class="pre">*</span></tt>. For example a filter like <tt class="docutils literal"><span class="pre">abc*</span></tt>, select all the strings having <tt class="docutils literal"><span class="pre">abc</span></tt> as prefix.</p>
<p>Filters inside <a class="reference internal" href="#term-call-report"><em class="xref std std-term">call report</em></a> add implicitly the <tt class="docutils literal"><span class="pre">*</span></tt> character to each search term, in order to simplify its usage for end users.</p>
</div>
<div class="section" id="online-help">
<h3>Online Help<a class="headerlink" href="#online-help" title="Permalink to this headline">¶</a></h3>
<p>Read carefully the notes of fields, and the comments at the bottom of each form.</p>
</div>
</div>
<div class="section" id="rating">
<h2>Rating<a class="headerlink" href="#rating" title="Permalink to this headline">¶</a></h2>
<p>Make sure understanding the <a class="reference internal" href="#cdr-rating-process"><em>basics of CDRs rating process</em></a> before defining and changing rates.</p>
<div class="section" id="error-in-rate-configurations">
<h3>Error in Rate Configurations<a class="headerlink" href="#error-in-rate-configurations" title="Permalink to this headline">¶</a></h3>
<p>During rating process, Asterisell signals rate errors and conflicts. Rates are usually the most difficult thing to configure in Asterisell, so at least initially, errors are the norm.</p>
<p>Asterisell has a safe approach during rating: a <a class="reference internal" href="#term-cdr"><em class="xref std std-term">CDR</em></a> is rated only if there is exactly one applicable classification rate, one cost rate, and one income rate, otherwise an error is signaled, and the CDR rating is postponed until rate configurations are fixed. So Asterisell prefers annoying the administrator with error-messages, than silently rating in the wrong way the VoIP calls.</p>
<p>Error notifications contain hints about the solution of the problem, so read them carefully.</p>
<dl class="docutils">
<dt>If properly configured, errors are notified to Asterisell administrator also by email:</dt>
<dd><ul class="first last simple">
<li>job <tt class="docutils literal"><span class="pre">AdviseAdminOfNewProblems</span></tt> in <a class="reference internal" href="#main-configurations"><em>Main Configurations</em></a> must be active;</li>
<li><tt class="docutils literal"><span class="pre">Customers</span> <span class="pre">support</span> <span class="pre">email,</span> <span class="pre">and</span> <span class="pre">automatic</span> <span class="pre">problem</span> <span class="pre">notification</span> <span class="pre">email</span></tt> field in <a class="reference internal" href="#asterisell-owner"><em>Asterisell Owner Params</em></a> must be specified;</li>
</ul>
</dd>
</dl>
<div class="section" id="unrated-cdrs">
<h4>Unrated CDRs<a class="headerlink" href="#unrated-cdrs" title="Permalink to this headline">¶</a></h4>
<p>CDRs with problems are not displayed to customers, but they are only visible to administrators in the <em class="menuselection">Calls ‣ Unprocessed Calls</em> web form. Note that in this section there are also the few CDRs that were inserted in the CDR table, after the last cron-job processing job. After the next rating process, they will be moved to the <a class="reference internal" href="#term-call-report"><em class="xref std std-term">call report</em></a>.</p>
</div>
<div class="section" id="examples-of-problem-solution">
<h4>Examples of Problem Solution<a class="headerlink" href="#examples-of-problem-solution" title="Permalink to this headline">¶</a></h4>
<p>An example of error notification:</p>
<blockquote>
<div><p>Description: No Rate to apply at date 2011-06-08 of type vendor (calculating a cost) on CDR with id <tt class="docutils literal"><span class="pre">11906</span></tt>, and destination_type <tt class="docutils literal"><span class="pre">outgoing</span></tt> for customer of price category <tt class="docutils literal"><span class="pre">Normal</span></tt> for external telephone number <tt class="docutils literal"><span class="pre">0033631988888</span></tt> (with number portability applied it is <tt class="docutils literal"><span class="pre">0033631988888</span></tt>), and for dstchannel <tt class="docutils literal"><span class="pre">SIP/abcd-12</span></tt>.</p>
<p>Effect: CDRs in the given rate interval will not be rated.</p>
<p>Suggested Solution: Complete the rate table and wait for the next rate pass. Use menu entry Calls/Unprocessed Calls, for inspecting all details of unprocessed calls.</p>
</div></blockquote>
<dl class="docutils">
<dt>Its solution:</dt>
<dd><ul class="first last simple">
<li>check all the active rates of type vendor, active at date 2011-06-08;</li>
<li>check if they are applicable to the telephone number <tt class="docutils literal"><span class="pre">0033631988888</span></tt>, and price category <tt class="docutils literal"><span class="pre">Normal</span></tt>;</li>
<li>fix the rate for supporting also this type, or add a new rate;</li>
<li>delete the problems from the list;</li>
<li>re-rate old CDRs that can be affected by the changes in rates;</li>
<li>check if the error is signaled again in the error table;</li>
<li>note that errors generated during on-line rerating are not sent to the administrators emails, in order to reducing the number of sent emails during administration and maintenance work.</li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="cdrs-re-rating">
<span id="cdr-rerating"></span><h3>CDRs Re-rating<a class="headerlink" href="#cdrs-re-rating" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>open <em class="menuselection">Calls ‣ Call Report</em>;</li>
<li>select the time frame of CDRs you want re-rate;</li>
<li>note that other filters take no effect during re-rating, only the time-frame criteria;</li>
<li>click on <cite>Re-rate Calls in Time-frame</cite>;</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="rates-updating">
<h3>Rates Updating<a class="headerlink" href="#rates-updating" title="Permalink to this headline">¶</a></h3>
<div class="section" id="in-advance">
<h4>In Advance<a class="headerlink" href="#in-advance" title="Permalink to this headline">¶</a></h4>
<p>If your <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a> communicates you the changes of rates before they take effect, you can create the corresponding new rates, specifying the start date and time. They will be applied only to CDRs after the starting date. You must also set the ending date of current rates, because after the new rates are active, they must be disabled.</p>
<p>This is the best way for updating the rates, because if you rerate CDRs, Asterisell can always apply the correct rate.</p>
</div>
<div class="section" id="current">
<h4>Current<a class="headerlink" href="#current" title="Permalink to this headline">¶</a></h4>
<p>If you update current rates, because there are errors, you must rerate current CDRs, otherwise the modified rates will be applied only to new inserted CDRs. CDRs are rerated <a class="reference internal" href="#cdr-rerating"><em>in this way</em></a>.</p>
</div>
<div class="section" id="changing-customer-price-category">
<h4>Changing Customer Price Category<a class="headerlink" href="#changing-customer-price-category" title="Permalink to this headline">¶</a></h4>
<p>Up to date customer price category has no start and end date, as in the case of rates. A customer has only one price category, and if you change it, it takes effect immediately. All new CDRs associated to the customer will be calculated according the new price category. If you want apply the price category also to old CDRs, you must rerate them <a class="reference internal" href="#cdr-rerating"><em>in this way</em></a>.</p>
<p>A drawback of this approach it is that if you rerate old CDRs of the customer, they will be rated according the current price category, and not the price category when the CDRs were made. This is obviously a problem in Asterisell specification of price categories. In practice this problem it is not severe, because usually a customer changes his price category at the beginning of the new invoicing period, and rarely CDRs already billed are re-rated. So the typically way for changing price category, is rerating all the CDRs of the current month.</p>
</div>
</div>
</div>
<div class="section" id="invoices">
<h2>Invoices<a class="headerlink" href="#invoices" title="Permalink to this headline">¶</a></h2>
<div class="section" id="generation">
<h3>Generation<a class="headerlink" href="#generation" title="Permalink to this headline">¶</a></h3>
<p><em class="menuselection">Accounting ‣ Customer Invoices</em> for generating the invoice of a single customer.</p>
<p><em class="menuselection">Accounting ‣ Batch Invoice Creation</em> for generating all invoices of active customers, of a specific billing period.</p>
<p><em class="menuselection">Accounting ‣ Vendor Invoices</em> for generating the amount you owe to your <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a>, according the costs calculated from Asterisell. The generated pseudo invoices should correspond to the invoices received from vendors.</p>
<p>If you change the cost of calls already invoiced, then the invoice is not updated automatically. You can force a regeneration of an invoice using the <tt class="docutils literal"><span class="pre">Regenerate</span> <span class="pre">Invoice</span> <span class="pre">button</span></tt> which is displayed in the edit form of an invoice. It can be used also for batch invoices, and all invoices are simply updated.</p>
</div>
<div class="section" id="sending-emails">
<h3>Sending Emails<a class="headerlink" href="#sending-emails" title="Permalink to this headline">¶</a></h3>
<p>Email is sent only if the <tt class="docutils literal"><span class="pre">Send</span> <span class="pre">email</span> <span class="pre">to</span> <span class="pre">customer</span></tt> button is pressed and the customer has an associated email.</p>
<p>If there were a problem sending an email, then Asterisell signal the problem, and mark the invoice as not sent.</p>
<p>If SMTP params are left incomplete, then Asterisell will simply not send emails, and it does not consider this an error.</p>
<p>If SMTP params are not correct then Asterisell signal the problem inside problem table.</p>
</div>
</div>
</div>
<div class="section" id="partners-and-resellers">
<h1>Partners and Resellers<a class="headerlink" href="#partners-and-resellers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="resellers">
<span id="id7"></span><h2>Resellers<a class="headerlink" href="#resellers" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="#term-reseller"><em class="xref std std-term">reseller</em></a> is a company selling VoIP calls to his customers, and where you play the role of his VoIP vendor.</p>
<dl class="docutils">
<dt>In case of resellers, there are two running instances of Asterisell:</dt>
<dd><ul class="first last simple">
<li>your main instance;</li>
<li>reseller instance;</li>
</ul>
</dd>
<dt>A reseller has distinct:</dt>
<dd><ul class="first last simple">
<li>Asterisell website address;</li>
<li>Asterisell database;</li>
<li>customers;</li>
<li>rates;</li>
<li>invoices;</li>
</ul>
</dd>
</dl>
<p>Usually a reseller uses your VoIP servers for managing the calls of his customers, and usually you install the Asterisell reseller instance on the same server of your main instance, but this is not mandatory.</p>
<div class="section" id="license">
<h3>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h3>
<p>You need a separate license of Asterisell for each reseller.</p>
</div>
<div class="section" id="main-asterisell-instance-configuration">
<h3>Main Asterisell Instance Configuration<a class="headerlink" href="#main-asterisell-instance-configuration" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>In your main Asterisell instance you must:</dt>
<dd><ul class="first last simple">
<li>make sure that in <cite>always_scheduled_jobs</cite> of <a class="reference internal" href="#main-configurations"><em>Main Configurations</em></a>, the job <cite>ExportCDRToReseller</cite> is active.</li>
<li>create a customer for the reseller;</li>
<li>enable the <cite>Is Reseller</cite> flag in the <em class="menuselection">Parties ‣ Customers / Vendors</em> form;</li>
<li>configure the <cite>reseller short code</cite>;</li>
</ul>
</dd>
</dl>
<p>Usually resellers have also a reseller price category.</p>
<p>From now all the CDRs of VoIP accounts associated to the reseller will be exported to CSV files, and put inside the directory <cite>cdr-exported-to-resellers/reseller-short-code</cite>. The directory will be created automatically from Asterisell. The CSV files have name like <cite>cdr-12345678.csv</cite> where <cite>123456789</cite> is a unique and progressive number.</p>
<p>In case of installation of reseller and main instance on the same machine, make sure that the main instance export directory is readable and writable from the cron-job.</p>
<dl class="docutils">
<dt>Supposing your reseller <cite>Gold</cite> has customer <cite>Acme</cite>, with VoIP account <cite>acme001</cite>:</dt>
<dd><ul class="first last simple">
<li>you must enable VoIP account <cite>acme01</cite> on your VoIP server;</li>
<li>in Asterisell, you must create the VoIP account <cite>acme01</cite> associated to customer <cite>Gold</cite>;</li>
<li>you <em>must not</em> create customer <cite>Acme</cite> on your Asterisell instance;</li>
</ul>
</dd>
</dl>
<p>So you don&#8217;t know anything about the customers of your reseller, and the applied rates. You only know about the VoIP accounts you manage, and what a reseller must pay you for this service.</p>
<p>Asterisell will produce a unique invoice with all the calls of the VoIP accounts associated to the reseller customer. This is the usual Asterisell work-flow, because a reseller is a normal customer inside Asterisell main instance.</p>
</div>
<div class="section" id="reseller-instance-configuration">
<h3>Reseller Instance Configuration<a class="headerlink" href="#reseller-instance-configuration" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Install Asterisell for the reseller.</li>
<li>Set <cite>external_asterisell_voip_provider</cite> options inside <a class="reference internal" href="#main-configurations"><em>Main Configurations</em></a>. If the two instances are put on separated computers/network, you must create some script copying new CSV files in the main Asterisell instance, in a local directory of the reseller instance.</li>
<li>Make sure that in <cite>always_scheduled_jobs</cite>, the jobs <cite>ImportCDRFromAsterisellProvider</cite> and <cite>CompareProviderCostWithCalculatedCost</cite> are active.</li>
<li>Set vendor rates equal to the rates you apply to reseller on the main Asterisell instance. Note: CDRs imported on the reseller  instance will be checked, and the reseller will be informed if there is some difference between the cost of VoIP calls calculated from main  instance, and the cost calculated from reseller  instance, applying the vendor rates.</li>
<li>Remove all classification rates, and add the <cite>ProcessImportedCDR</cite> classification rate. This rate recognizes CDRs imported from the main Asterisell instance.</li>
<li>Create initial customers, using the same VoIP accounts enabled on the main instance. Note: it is not important activating accounts first on reseller or first on main instance, because data will be not lost in any case.</li>
</ul>
</div></blockquote>
<p>Reseller instance will produce an invoice for each of his customers. This is the normal Asterisell work-flow, because every reseller customer, is a normal customer inside reseller instance.</p>
</div>
<div class="section" id="rerating-of-cdrs">
<h3>Rerating of CDRs<a class="headerlink" href="#rerating-of-cdrs" title="Permalink to this headline">¶</a></h3>
<p>If already exported CDRs will be rated again on the Asterisell main instance (for example after changing rates, or fixing errors), they will be exported again to the reseller, and reseller instance will update the old CDRs with new values, without creating duplicated/conflicting CDRs.</p>
<dl class="docutils">
<dt>So reseller instance can recognize and manage properly all events like:</dt>
<dd><ul class="first last simple">
<li>a CDR changed cost/income;</li>
<li>a CDR changed VoIP account;</li>
<li>a CDR changed outgoing/incoming/internal state;</li>
<li>a CDR changed destination/source telephone number;</li>
<li>and so on..;</li>
</ul>
</dd>
</dl>
<p>The only exception is in case of CDRs becoming <a class="reference internal" href="#term-ignored-call"><em class="xref std std-term">ignored call</em></a> on the Asterisell main instance, after they were already sent as a different CDR type. In practice this is not a big problem because rules about CDRs to ignore, rarely change.</p>
</div>
</div>
<div class="section" id="partners">
<span id="id8"></span><h2>Partners<a class="headerlink" href="#partners" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="#term-partner"><em class="xref std std-term">partner</em></a> is another company collaborating with you, that uses your same Asterisell instance, and the same VoIP server.</p>
<dl class="docutils">
<dt>Partners can have distinct:</dt>
<dd><ul class="first last simple">
<li>customers;</li>
<li>invoices;</li>
<li>login page;</li>
<li>web site logo, header, footer;</li>
<li>rates;</li>
</ul>
</dd>
</dl>
<p>All partners have the same administrator privileges on the same Asterisell instance, so they can read and change all the data of other partners.</p>
<div class="section" id="id9">
<h3>License<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>On the contrary of resellers, partners can use both the same Asterisell license, because it is the same Asterisell instance.</p>
</div>
<div class="section" id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Create a partner on <em class="menuselection">Params ‣ Params</em>.</li>
<li>Associate customers to their partner.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id10">
<h3>Invoices<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Each customer invoice will use as seller the corresponding partner.</p>
</div>
<div class="section" id="custom-login-page">
<h3>Custom Login Page<a class="headerlink" href="#custom-login-page" title="Permalink to this headline">¶</a></h3>
<p>After login a customer see always the logo, header and footers of his associated partner.</p>
<p>Before login it is not possible, because there is a unique Asterisell web address for each partner. So you must use a common header for all partners.</p>
<p>It is possible creating a custom login page, with a specific address, for each partner.. In <em class="menuselection">Params ‣ Params</em> web form, you can specify in <cite>Login URN</cite> a URL-friendly short name for the partner. Then the custom login page with the headers and footers of the partner is accessible on something like <cite>https://www.example.com/partner-name</cite>.</p>
</div>
</div>
<div class="section" id="main-configuration-file-content">
<span id="main-configuration-file"></span><h2>Main Configuration File Content<a class="headerlink" href="#main-configuration-file-content" title="Permalink to this headline">¶</a></h2>
<p><tt class="file docutils literal"><span class="pre">apps/asterisell/config/app.yml</span></tt></p>
<div class="highlight-python"><pre># !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! #
# !!!                                                                           !!! #
# !!! I M P O R T A N T:                                                        !!! #
# !!!                                                                           !!! #
# !!! 1) if you change these values then execute                                !!! #
# !!!                                                                           !!! #
# !!!    &gt; php asterisell.php activate                                          !!! #
# !!!                                                                           !!! #
# !!! in order to update the application behaviour;                             !!! #
# !!!                                                                           !!! #
# !!! 2) many parameters need a rerate of old calls in order to be propagated   !!! #
# !!! also to old calls. When this is the case, it is signaled in the parameter !!! # 
# !!! comments as "IMPORTANT"                                                   !!! #
# !!!                                                                           !!! #
# !!! 3) avoid TABS inside this file, they are not accepted, use only SPACES    !!! #
# !!!                                                                           !!! #
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! #

all:

  # Source code upgrade command.
  #
  # In case of commercial version replace the git source location,
  # with the corresponding address, containing the license key.
  #
  # In case of separated production and test instances:
  #   - point test instance to free or commercial license link;
  #   - point the production instance to the test instance;
  # In this way, you can first resolve conflicts on the test instance,
  # and then import them in the production instance.
  #
  git_upgrade_command: git pull https://github.com/massimo-zaniboni/Asterisell

  # The Unix user that must owns the files that must be readable from the web server.
  # It depends from your distrubution:
  #   - www-data for Debian;
  #   - apache for Centos;
  #   - http for Arch;
  #
  # It is the "User" directive of Apache Web Server configuration files.
  #
  web_server_user: http

  available:

    # The PhpRate class available during the setup of a rate plan.
    # The class are located in apps/asterisell/lib/ directory.
    # You can add your own classed.
    # The format is: 
    #
    # &gt; PHP-Class-Name: Rate Description
    #
    phpRates: 
      ProcessImportedCDR: Process CDR imported from VoIP vendor
      PhpCDRProcessing: CDR initial classification
      PhpRateByDuration: By Duration
      PhpRateImportFromCSV: CSV File with Tel.Prefixes and Rates
      MinimumCostBundleRate: Account Minimum Cost
      UseImportedSourceCost: Use VoIP provider cost.
      # DataUpgradeRatePass1: Imported CDR from previous Asterisell versions, pass 1  
      # DataUpgradeRatePass2: Imported CDR from previous Asterisell versions, pass 2

    # These jobs are executed every time the job-queue processor
    # is invoked. They are indipendent from job-data or events.
    # They are executed before "available jobs".
    #
    # These jobs are processed following the order of declaration.
    #
    # These jobs are processed only one time for each activation
    # of the JobQueueProcessor.
    #
    # These jobs are of class FixedJobProcessor.
    #
    # NOTE: if one of this jobs fails, then the next job is executed 
    # in any case.
    #
    # IMPORTANT: Changes to this parameter make effect only on new rated calls,
    # so you must force a rerate if you want apply the new mask only to already
    # rated calls.
    #
    always_scheduled_jobs:
      - ImportCDRFromAsterisellProvider     # does nothing if there are no provider settings (see below)
      - RateCalls
      - ExportCDRToReseller                 # does nothing if there are no resellers
      - CheckSafeLimitForConcurrentCalls    # warn if the Asterisell server has reached a big number of concurrent calls
      - CheckCallCostLimit
      - CheckFrauds                         # see check_frauds options in this file for configuring it
      - CleanCacheFromOldItems              # maintanance work
      - CheckWebsiteUpdates                 # check if there are news on Asterisell web-site
      - CheckPartiesWithoutParams           # maintanance work
      # - CompareProviderCostWithCalculatedCost  # in case of CDR imported from a provider sending also his calculated cost, 
                                                 # check them with Asterisell calculated cost
      - AdviseAdminOfNewProblems            # send emails with found problems to administrator

    # The jobs that are activate when there is a compatible event
    # on the job queue.
    #
    # Jobs are iteratively checked for every initial and new event,
    # so if a Job fires new events, they can be immediately processed
    # from other jobs.
    #
    # These jobs are of class JobProcessor.
    #
    # IMPORTANT: Changes to this parameter make effect only on new rated calls,
    # so you must force a rerate if you want apply the new mask only to already
    # rated calls.
    #
    jobs:
      - GenerateInvoices
      - GenerateInvoiceDetails
      - GenerateInvoiceReportAsHTML
      - GenerateInvoiceReportAsPDF  
      # - GenerateInvoiceAsCenteredTemplate   # this is another type of invoice format, enable this or `GenerateInvoiceReportaAsPDF` or another format
      - GenerateCallReportAsPDF
      - GenerateInvoiceEmail
      - SendInvoiceEmails
      - SendInvoiceEmail
      - SendInvoiceNotificationToAccountant
      # - GenerateMailWarningCustomerForHighCallCost  # ...
      # - WarnCustomerForHighCallCost                 # activate these two jobs if you want send an email directly to customer in case of high call costs.

  # Complete only if this Asterisell instance is a reseller of another
  # Asterisell server acting like a VoIP provider.
  # 
  # NOTE: if this is the Asterisell acting like a main VoIP provider, these
  # settings must be left empty. They must be completed on the reseller side.
  #
  # NOTE: these options can be used only for commercial version of Asterisell.
  #
  external_asterisell_voip_provider:
    csv_files_source_directory: ""
    temp_processing_csv_files_directory: ""
    processed_csv_files_directory: ""
    insert_cdr_using_dstchannel: ""

  # Enable/disable displaying of incoming/incoming/internal 
  # calls in the customer call report.
  # This allows to reduce the information overhead.
  #
  # This settings influence also INVOICE GENERATION:
  # if incoming/internal calls are not displayed in the CALL REPORT
  # then they are not displated / summed up in the invoices,
  # otherwise they are showed / summed up in the invoices.
  #
  # IMPORTANT: if you assign an earn to incoming and internal 
  # calls, but they are not displayed in the call report,
  # then these earns are lost because they are not inserted
  # in the invoices. The underline philosophy of Asterisell
  # is that you can account to customers only showed costs
  # in the call report.
  #
  # Ignored and Unprocessed calls are not displayed by default.
  #
  # The administrator can all these type of calls, 
  # in any case, indipendently from these settings.
  #
  # allowed values: true / false (case sensitive)
  #
  show_incoming_calls: false
  show_outgoing_calls: true
  show_internal_calls: false
  
  # Display in the customer call report also 
  # the direction of the call (incoming/outgoing/internal)
  # for each call.
  #
  # The administrar is not affected from this setting, because 
  # he sees always the call direction.
  #
  # If both incoming and outgoing calls are displayed, the safer
  # approach is enabling also displying of call direction, otherwise
  # can be difficult for the end-user, distinguish between the type 
  # of a call.
  #
  # allowed values: true / false (case sensitive)
  #
  show_call_direction: false

  # Display in the customer call report
  # also a filter on the call direction (incoming/outgoing/internal).
  #
  # This setting influence only the call report
  # of customer. The administrator can always
  # filter on call direction.
  #
  show_filter_on_call_direction: false

  # How many calls shows in the call report
  # containing the list of made calls.
  # This is the main report of the program.
  # 
  how_many_calls_in_call_report: 30

  # True for showing invoices marked as sent, to customers that are on line.
  #
  show_online_sent_invoices_to_customers: false

  # External telephone number with the specified
  # prefix are displayed in a short form, without
  # the prefix.
  # 
  # This option is useful when all your customers
  # reside in the same area. So you can remove 
  # the standard/default prefix from called numbers
  # when they are in the standard/default area.
  #
  # All other numbers are not modified.
  # 
  # In any case, this option does not change the
  # stored numbers inside the database, only their
  # visualization.
  #
  # Use "-", if you want to disable this feature.
  #
  # IMPORTANT: Changes to this parameter make effect only on new rated calls,
  # so you must force a rerate, if you want apply the new settings
  # also to already rated calls.
  #
  not_displayed_telephone_prefix: "-"

  # Check cost-limits and CheckFrauds, interval expressed in minutes.
  # Cost-limits check is an heavy operation to do and 
  # it must be executed after a certain interval of time.
  # The job log show if the operation is requiring too much.
  check_cost_limits_after_minutes: 15

  # In case the job GenerateMailWarningCustomerForHighCallCost 
  # is enabled (it is inserted in the list of active jobs), 
  # this params set how often a customer is warned
  # about his call cost exceeding his cost limit.
  #
  # 0 for disable customer advise (only admin is advised).
  #
  repeat_advise_of_high_cost_limit_after_days: 0

  # How to calculate the max cost limit for each customer.
  #
  # "30" for considering the cost of last 30 days.
  # "m" for considering the current month.
  # 
  max_cost_limit_timeframe: m

   # Used from job CheckFrauds (enabled only in commercial version)
   # The job run according the scheduling of `check_cost_limits_after_minutes`
   #
   check_frauds:
     max_unprocessed_calls: 10
     # if there are more than these unprocessed calls,
     # then advise the administrator, because there can be unnoticed high calls costs

     compare_xx_last_days_respect_customer_daily_max_cost: 5
     # note: customer daily max cost is the customer monthly max cost, specified in the user interface,
     # divided by 30. Set to 0 for disabling it.

     compare_x_last_months_respect_current_costs: 3
     # warn if a customer spent a 25% more than the maximum cost of last x months in the
     # same day of week and a comparable hour of the day (hours grouped by 00-06, 06-12, 12-18, 18-24).
     # Set to 0 for disabling it.

  # How many concurrent calls, the Asterisk server can support in a safely
  # manner. If this number of concurrent calls is reached, 
  # then the administrator is advised.
  # 
  # This number depends from the incoming/outgoing bandwidth of the Asterisell
  # server and from the bandwidth reserved/used from each call/connection.
  # It is only an indicative/warning value, used for monitoring when
  # the system reach a warning usage level.
  # 
  safe_limit_for_concurrent_calls: 5

  # The format to use for date/timestamp display in CDR call report.
  # The format is specified using PHP "date" function format:
  #    http://www.php.net/manual/en/function.date.php
  #
  date_format: "Y/m/d, G:i:s"
    # "r" for something like "Thu, 21 Dec 2000 16:01:07 +0200"
    # "c" for something like "2004-02-12T15:19:21+00:00"
    # "F d, Y G:i:s" for something like "Dec 21, 2000 16:01:07"
    # "d/m/Y, G:i:s" for italian format

  # The format to use for date display in Invoices
  #
  # IMPORTANT: Changes to this parameter make effect only on new generated invoices.
  #
  invoice_date_format: "Y-m-d"
  # invoice_date_format: "d/m/Y"  for italian format

  # true for having invoices with details like:
  # &gt; Italy - Fixed Line        200 calls  ....
  # &gt; Italy - Mobile Line       100 calls  ...
  # (grouped by geographi location and type of operator)
  #
  # false for having invoices with details like:
  # &gt; Fixed Line                 200 calls
  # &gt; Mobile Lines               100 calls
  # (grouped by type of operator. 
  #  Maybe you can further create operators like "National Fixed Line", 
  # "International Fixed Line" and os on...)
  #
  long_details_in_invoice: true

  # true for using the last day of the month, in invoices of the month,
  # like "from 2011-06-01 to 2011-06-30".
  #
  # false for using the first day of the next month, in invoices of the month, 
  # like "from 2011-06-01 to 2011-07-01".
  # 
  use_inclusive_end_date_in_invoice: false

  # the default currency used for rates, cost and incomes.
  #
  currency: EUR
  # currency: USD
  # currency: AUD

  # The ASCII char to use for representing the currency
  # in PDF and textual forms.
  #
  # EUR: 128
  # US: 36
  # GBP: 163
  # 
  # IMPORTANT: Changes to this parameter make effect only on new generated invoices.
  #
  currency_ascii_char: 128

  # The decimal separator symbol to use in CSV files exported to customers.
  #
  decimal_separator_symbol_in_csv: "."

  # true for exporting numbers like "1.234" in CSV files exported to customers.
  # false for exporting numbers like 1.234 (without \").
  #
  # true is a more safe option of your customers have different locale 
  # with different types of decimal separator.
  #
  # false allows recognizing more easily numbers, during importing of CSV files
  # inside a spreadsheet.
  #
  numbers_as_strings_in_csv: true

  # The field separator used in CSV files exported to customers.
  # Normally it is ",".
  #
  # If you are using "," also as decimal separator, 
  # and numbers are not surrounded between \", then use something like ";".
  #
  csv_field_separator: ","

  # The default culture to use for formatting numbers, dates and so on.
  # Something like en_US, it_IT, ...
  #
  # IMPORTANT: if you change this value update also the corresponding
  # "apps/asterisell/config/settings.yml" file in "prod: default_culture".
  # This is not strictly necessary because after login, Asterisell
  # set the culture of the session to this value, but it is 
  # a safe setting.
  #
  # culture: en_US
  # culture: it_IT
  culture: en_US

  # decimal places to use for currency when stored in the database CDR table
  #
  # IMPORTANT: if you change this value then force a re-rate of all calls
  # because already rated calls will be in an inconsisten format.
  #
  currency_decimal_places: 4

  # decimal places to use for each currency in an invoice
  #
  # IMPORTANT: Changes to this parameter make effect only on new generated invoices.
  #
  # IMPORTANT: this parameter is also used for rounding
  # costs/incomes in CALL REPORT. Supposing 2 decimal places,
  # a cost like "0.005" is rounded to "0.01".
  # 
  currency_decimal_places_in_invoices: 2

  # If these field is an empty list ([]) then "cdr.dst" field is the destination
  # telephone number of the call.
  #
  # If the value of this setting is a list then
  # cdr.lastdata field is the destination telephone number of the call.
  # For each billable call, "cdr.lastapp" must be a value inside the list, 
  # otherwise the call is not rated and the problem 
  # is signaled to the administrator. 
  # 
  # IMPORTANT: Changes to this parameter make effect only on new rated calls,
  # so you must force a rerate if you want apply the new mask only to already
  # rated calls.
  # 
  lastapp_accepted_values: []

  # The internal telephone number is the VoIP account code,
  # managed from the Asterisk server.
  #
  # The external telephone number is the number residing on 
  # external lines, reachable using the services of the
  # VoIP service provider.
  #
  # In an outgoing call, the internal telephone number is the source of the call.
  # In an incoming call, the internal telephone number is the destination of the call.
  #
  # In an outgoing call, the external telephone number is the destination of the call.
  # In an incoming call, the external telephone number is the source of the call.
  #
  # Asterisell displays in CALL REPORT something like:
  #
  # &gt; | INTERNAL VoIP Account | Call Direction | EXTERNAL Telephone Number |
  # &gt; +-----------------------+----------------+---------------------------+
  # &gt; | account123            |    outgoing    | 390423XXXX                |
  # &gt; | account123            |    incoming    | 39343XXXXX                |
  #
  # so the distinction is between internal and external telephone number
  # and not between call source and destination.
  # The same distinction is done also in the rate forms.
  #
  # The problem is: what fields of the CDR record must Asterisell 
  # use for displaying in the call report the internal and external telephone number?
  #
  # Available options:
  # * 0: use "accountcode" field as internal telephone number (display in CALL REPORT the account-code name),
  #      use "dst/lastapp_accepted_values" field as external telephone number.
  # * 1: use "src" field as internal telephone number only for outgoing calls, 
  #      use "src" field as external telephone number only for incoming calls,
  #      use "dst/lastapp_accepted_values" as external telephone number only for outgoing calls,
  #      use "dst/lastapp_accepted_values" as internal telephone number only for incoming calls.
  #      in case of unprocessed/ignored/internal use always "src" field for internal calls.
  # * 2: use "src" field as internal telephone number,
  #      use "dst/lastapp_accepted_values" field as external telephone number.
  #      in case of unprocessed/ignored/internal use always "src" field for internal calls.
  # * 3: it is assigned from the CDRInitialProcessing rate, that must complete during initial processing of a rate,
  #      these fields:
  #        - `cdr.ar_asterisk_account_id` (null if it is missing, and RateProcess will inform the user of the error);
  #        - `cdr.cached_internal_telephone_number`;
  #        - `cdr.cached_external_telephone_number`;
  #        - `cdr.cached_masked_external_telephone_number`, can be null (it is completed from the framework), or with an explicit value
  #        - `cdr.ar_telephone_prefix.id` can be null (it is completed from the framework),
  #           or with an explicit value, in this case number portability is not automatically transferred to the telephone prefix,
  #           and it must be explicitely managed from the CDR processor;
  #      See `apps/asterisell/lib/rates/CustomCDRProcessing.php` for a template of associated processing rate.
  #      A rate like the proposed example must be added to the rate table.
  # * 4: use "accountcode" field as internal telephone number (display in CALL REPORT the account-code name),
  #      use "dst" as external telephone number for outgoing and internal calls,
  #      use "src" as external telephone number for incoming calls.
  #
  # IMPORTANT: Changes to this parameter make effect only on new rated calls,
  # so you must force a rerate if you want apply the new mask only to already
  # rated calls.
  # 
  internal_external_telephone_numbers: 0

  # An external telephone number can be masked in the CALL REPORT view,
  # for privacy reasons.
  #
  # This parameter identifies the number of last digits to mask in the
  # external telephone number.
  #
  # A typical value is 3 digits to mask, in order to obtain something
  # like "39059567XXX".
  #
  # 0 stays for no number masking.
  #
  # Internal calls (in the case they are displayed in the
  # CALL REPORT), between two VoIP accounts are no masked.
  #
  # Unprocessed calls are never masked, but they are viewable
  # only from the administrator.
  #
  # IMPORTANT: Changes to this parameter make effect only on new rated calls,
  # so you must force a rerate if you want apply the new mask only to already
  # rated calls.
  # 
  # IMPORTANT: Changes to this parameter make effect only on new rated calls,
  # so you must force a rerate if you want apply the new mask only to already
  # rated calls.
  # 
  mask_for_external_telephone_number: 3

  # Remove a log message from the Job Log Table 
  # when it is older than this number of months.
  #
  months_after_removing_a_job_log_entry: 2

  # Where uploaded files are put/read.
  # This is a directory inside "web" directory,
  # and it must be web-server readable and writable.
  #
  # This default directory is already created.
  # If you set up a new directory, you must manually
  # create it.
  #
  sfMediaLibrary:
    upload_dir: uploads/assets
    
</pre>
</div>
</div>
</div>
<div class="section" id="development">
<h1>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h1>
<div class="section" id="project-repository">
<h2>Project Repository<a class="headerlink" href="#project-repository" title="Permalink to this headline">¶</a></h2>
<p>This is the project page <a class="reference external" href="http://github.com/massimo-zaniboni/Asterisell">http://github.com/massimo-zaniboni/Asterisell</a></p>
</div>
<div class="section" id="symfony-framework">
<h2>Symfony Framework<a class="headerlink" href="#symfony-framework" title="Permalink to this headline">¶</a></h2>
<p>Asterisell uses the <a class="reference external" href="http://www.symfony-project.com">Symfony PHP framework</a>, that is a well designed and documentated framework.</p>
<p>Asterisell distribution contanins a &#8220;snapshot&#8221; of the Symfony framework, version 1.0.5. The directory <cite>symfony-patch</cite> contains some patches to the framework. They are already applied to the version shipped with Asterisell.</p>
</div>
<div class="section" id="debug">
<h2>Debug<a class="headerlink" href="#debug" title="Permalink to this headline">¶</a></h2>
<p>In order to enable the development mode execute:</p>
<div class="highlight-python"><pre>symfony enable asterisell dev</pre>
</div>
<p>If Asterisell project is in the <cite>/var/www/asterisell</cite> directory and your local apache server is listening on port 3000, then you must open the web page <cite>http://localhost:3000/asterisell/web/asterisell_dev.php/login</cite>.</p>
</div>
<div class="section" id="localization">
<h2>Localization<a class="headerlink" href="#localization" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>If you want to support a new language / culture you must:</dt>
<dd><ul class="first last simple">
<li>add to <cite>apps/asterisell/config/app.yml</cite> the new currency and culture;</li>
<li>copy <cite>apps/asterisell/i18n/messages.it.xml</cite> to <cite>apps/asterisell/i18n/messages.your_culture_code.xml</cite>;</li>
<li>replace all Italian translations with your locale translations;</li>
<li>execute <strong class="command">php asterisell.php activate</strong> in order to clear the cache and view the new messages;</li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="glossary">
<h1>Glossary<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h1>
<dl class="glossary docutils">
<dt id="term-asterisell-owner">Asterisell owner</dt>
<dd>You: a company selling VoIP services to his <a class="reference internal" href="#term-customer"><em class="xref std std-term">customers</em></a>. It uses one or more <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendors</em></a>, and it can have optionally one or more <a class="reference internal" href="#term-partner"><em class="xref std std-term">partners</em></a>.</dd>
<dt id="term-bundle-rate">bundle rate</dt>
<dd>A rate associated to the set of CDRs of the invoicing period, as the minimum income, or line rentals.</dd>
<dt id="term-call-report">call report</dt>
<dd>The web page displaying all the VoIP calls, and related data to administrator or to end users. It displays specialized information according the type of logged user.</dd>
<dt id="term-cdr">CDR</dt>
<dd>A call detail record of the <a class="reference internal" href="#term-cdr-table"><em class="xref std std-term">CDR table</em></a>, containing all the details of a VoIP call.</dd>
<dt id="term-cdr-table">CDR table</dt>
<dd>A MySQL table where the VoIP server put details about the VoIP calls.</dd>
<dt id="term-classification-rate">classification rate</dt>
<dd>A rate that classifies the <a class="reference internal" href="#term-cdr"><em class="xref std std-term">CDR</em></a> as <a class="reference internal" href="#term-outgoing-call"><em class="xref std std-term">outgoing call</em></a>, or <a class="reference internal" href="#term-incoming-call"><em class="xref std std-term">incoming call</em></a>, or <a class="reference internal" href="#term-internal-call"><em class="xref std std-term">internal call</em></a>, or <a class="reference internal" href="#term-ignored-call"><em class="xref std std-term">ignored call</em></a>.</dd>
<dt id="term-cost-rate">cost rate</dt>
<dd>A rate that assigns the cost of the <a class="reference internal" href="#term-cdr"><em class="xref std std-term">CDR</em></a>, that is what you (the <a class="reference internal" href="#term-asterisell-owner"><em class="xref std std-term">Asterisell owner</em></a>) must pay to another <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a> for routing the calls.</dd>
<dt id="term-customer">customer</dt>
<dd>A party that uses the services of <a class="reference internal" href="#term-asterisell-owner"><em class="xref std std-term">Asterisell owner</em></a> for making VoIP calls. He can have one or more <a class="reference internal" href="#term-customer-office"><em class="xref std std-term">customer offices</em></a>.</dd>
<dt id="term-customer-office">customer office</dt>
<dd>It identifies distinct physical locations, or distinct business units, of a <a class="reference internal" href="#term-customer"><em class="xref std std-term">customer</em></a>. It can have one or more <a class="reference internal" href="#term-voip-account"><em class="xref std std-term">VoIP accounts</em></a>.</dd>
<dt id="term-external-telephone-number">external telephone number</dt>
<dd>It is the number residing on external lines, reachable using the services of the <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a>. In case of <a class="reference internal" href="#term-outgoing-call"><em class="xref std std-term">outgoing call</em></a>, it is the destination of the call. In case of <a class="reference internal" href="#term-incoming-call"><em class="xref std std-term">incoming call</em></a>, it is the source of the call.</dd>
<dt id="term-ignored-call">ignored call</dt>
<dd>A call that has no income, cost, and that is not displayed in the <a class="reference internal" href="#term-call-report"><em class="xref std std-term">call report</em></a>. It can be completely ignored.</dd>
<dt id="term-income-rate">income rate</dt>
<dd>A rate that assigns the income of the <a class="reference internal" href="#term-cdr"><em class="xref std std-term">CDR</em></a>, that is what the <a class="reference internal" href="#term-customer"><em class="xref std std-term">customer</em></a> must pay for it.</dd>
<dt id="term-incoming-call">incoming call</dt>
<dd>A call coming from a telephone network not directly managed from you, and having one of your customer <a class="reference internal" href="#term-voip-account"><em class="xref std std-term">VoIP account</em></a> as destination.</dd>
<dt id="term-internal-call">internal call</dt>
<dd>A call inside a telephone network directly managed from you. The call source and destination are usually both associated to your customers.</dd>
<dt id="term-internal-telephone-number">internal telephone number</dt>
<dd>It is the <a class="reference internal" href="#term-voip-account"><em class="xref std std-term">VoIP account</em></a> code. In case of <a class="reference internal" href="#term-outgoing-call"><em class="xref std std-term">outgoing call</em></a>, it is the source of the call. In case of <a class="reference internal" href="#term-incoming-call"><em class="xref std std-term">incoming call</em></a>, it is the destination of the call.</dd>
<dt id="term-outgoing-call">outgoing call</dt>
<dd>A call directed to a telephone network not directly managed from you, and having one of your customer <a class="reference internal" href="#term-voip-account"><em class="xref std std-term">VoIP account</em></a> as source of the call.</dd>
<dt id="term-partner">partner</dt>
<dd>A Partner is a company collaborating with you, that uses your same Asterisell instance for selling VoIP calls to his customers.</dd>
<dt id="term-reseller">reseller</dt>
<dd>A Reseller is a company selling VoIP calls to his customers, and where you play the role of his <a class="reference internal" href="#term-voip-vendor"><em class="xref std std-term">VoIP vendor</em></a>.</dd>
<dt id="term-voip-account">VoIP account</dt>
<dd>A VoIP internal telephone number managed from the Asterisk server.
It is an internal account code. Usually Asterisk VoIP server put it on the <tt class="docutils literal"><span class="pre">accountcode</span></tt> field of the <a class="reference internal" href="#term-cdr-table"><em class="xref std std-term">CDR table</em></a>.
Note: the Asterisk standard documentation pretends that this code is specified on a per-channel basis, but this is not the case in Asterisell configuration. So each accountcode has the same associated customer for every channel. This is also useful/practical in case of the same customer using different channels.</dd>
<dt id="term-voip-vendor">VoIP vendor</dt>
<dd>A company that can route VoIP calls to destination end-points, typically traditional telephone networks. It is used from the <a class="reference internal" href="#term-asterisell-owner"><em class="xref std std-term">Asterisell owner</em></a> for routing the VoIP calls.</dd>
<dt id="term-web-server-user">Web Server User</dt>
<dd>The unix user associated to the Web Server process. Asterisell files can be read/written only if they are readable/writable from this user. Linux distributions can use different users: <cite>www-data</cite> for Debian, <cite>apache</cite> for Centos and RedHat, <cite>http</cite> for Arch, and so on. It is the <cite>User</cite> directive value, as specified inside Apache Web Server configuration files.</dd>
</dl>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="#">
              <img class="logo" src="_static/asterisell.png" alt="Logo"/>
            </a></p>
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Asterisell Overview</a></li>
<li><a class="reference internal" href="#installation">Installation</a><ul>
<li><a class="reference internal" href="#requirements">Requirements</a></li>
<li><a class="reference internal" href="#software-infrastructure">Software Infrastructure</a></li>
<li><a class="reference internal" href="#download">Download</a><ul>
<li><a class="reference internal" href="#file-permissions">File Permissions</a></li>
<li><a class="reference internal" href="#packages">Packages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mysql-database-configuration">MySQL Database Configuration</a><ul>
<li><a class="reference internal" href="#database-access-parameters">Database Access Parameters</a></li>
<li><a class="reference internal" href="#how-to-create-a-database-user-with-limited-access-to-asterisell-database">How to create a Database User with Limited Access to Asterisell Database</a></li>
<li><a class="reference internal" href="#installation-script">Installation Script</a></li>
<li><a class="reference internal" href="#change-demo-data-later">Change Demo Data Later</a></li>
<li><a class="reference internal" href="#mysql-advanced-optimizations">MySQL advanced optimizations</a></li>
<li><a class="reference internal" href="#optional-configuration-for-developers">Optional Configuration for Developers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#web-server">Web Server</a><ul>
<li><a class="reference internal" href="#website-configuration">Website Configuration</a></li>
<li><a class="reference internal" href="#php-resources">PHP Resources</a></li>
<li><a class="reference internal" href="#php-speedup">PHP Speedup</a></li>
<li><a class="reference internal" href="#mysql">MySQL</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cron-job">Cron Job</a><ul>
<li><a class="reference internal" href="#calls-rating-and-jobs-processing">Calls Rating and Jobs Processing</a></li>
<li><a class="reference internal" href="#user-permissions">User Permissions</a></li>
<li><a class="reference internal" href="#cron-job-setting">Cron Job Setting</a></li>
<li><a class="reference internal" href="#log-rotate">Log Rotate</a></li>
</ul>
</li>
<li><a class="reference internal" href="#asterisell-customizations">Asterisell Customizations</a><ul>
<li><a class="reference internal" href="#jobs-workflow-customizations">Jobs/Workflow Customizations</a></li>
<li><a class="reference internal" href="#rates-customizations">Rates Customizations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#id3">File Permissions</a><ul>
<li><a class="reference internal" href="#log-directory">Log Directory</a></li>
<li><a class="reference internal" href="#created-files">Created Files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#additional-run-time-debug-info">Additional Run-Time Debug Info</a></li>
<li><a class="reference internal" href="#run-time-configuration-problems">Run Time Configuration Problems</a></li>
<li><a class="reference internal" href="#feedback">Feedback</a></li>
</ul>
</li>
<li><a class="reference internal" href="#security">Security</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrading">Upgrading</a><ul>
<li><a class="reference internal" href="#migrating-from-free-to-commercial-version">Migrating from Free to Commercial Version</a></li>
<li><a class="reference internal" href="#procedure-outline">Procedure Outline</a></li>
<li><a class="reference internal" href="#merge-your-customizations-with-new-asterisell-version">Merge your customizations with new Asterisell version</a></li>
<li><a class="reference internal" href="#code-refresh">Code refresh</a></li>
<li><a class="reference internal" href="#reducing-application-downtime">Reducing Application Downtime</a></li>
<li><a class="reference internal" href="#testing-environment-with-a-testing-database">Testing Environment With a Testing Database</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configurations">Configurations</a><ul>
<li><a class="reference internal" href="#main-configurations">Main Configurations</a></li>
<li><a class="reference internal" href="#asterisell-owner-params">Asterisell Owner Params</a></li>
<li><a class="reference internal" href="#web-site-appearances">Web Site Appearances</a></li>
<li><a class="reference internal" href="#vendors-specification">Vendors Specification</a></li>
<li><a class="reference internal" href="#customers-specification">Customers Specification</a></li>
<li><a class="reference internal" href="#telephone-prefixes-in-call-report">Telephone Prefixes in Call Report</a></li>
<li><a class="reference internal" href="#rates">Rates</a><ul>
<li><a class="reference internal" href="#classification-rates">Classification Rates</a></li>
<li><a class="reference internal" href="#telephone-number-normalizations">Telephone Number Normalizations</a></li>
<li><a class="reference internal" href="#ignored-cdrs">Ignored CDRs</a></li>
<li><a class="reference internal" href="#internal-cdrs">Internal CDRs</a></li>
<li><a class="reference internal" href="#incoming-calls">Incoming Calls</a></li>
<li><a class="reference internal" href="#revenue-sharing">Revenue Sharing</a></li>
<li><a class="reference internal" href="#normal-rates">Normal Rates</a></li>
<li><a class="reference internal" href="#rate-priorities">Rate Priorities</a></li>
<li><a class="reference internal" href="#price-categories">Price Categories</a></li>
<li><a class="reference internal" href="#vendor-rates">Vendor Rates</a></li>
<li><a class="reference internal" href="#rates-specified-using-csv-files">Rates Specified Using CSV Files</a></li>
<li><a class="reference internal" href="#bundle-rates">Bundle Rates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#invoicing">Invoicing</a><ul>
<li><a class="reference internal" href="#report-about-calls">Report about Calls</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#user-interface">User Interface</a><ul>
<li><a class="reference internal" href="#filters">Filters</a></li>
<li><a class="reference internal" href="#online-help">Online Help</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rating">Rating</a><ul>
<li><a class="reference internal" href="#error-in-rate-configurations">Error in Rate Configurations</a><ul>
<li><a class="reference internal" href="#unrated-cdrs">Unrated CDRs</a></li>
<li><a class="reference internal" href="#examples-of-problem-solution">Examples of Problem Solution</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cdrs-re-rating">CDRs Re-rating</a></li>
<li><a class="reference internal" href="#rates-updating">Rates Updating</a><ul>
<li><a class="reference internal" href="#in-advance">In Advance</a></li>
<li><a class="reference internal" href="#current">Current</a></li>
<li><a class="reference internal" href="#changing-customer-price-category">Changing Customer Price Category</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#invoices">Invoices</a><ul>
<li><a class="reference internal" href="#generation">Generation</a></li>
<li><a class="reference internal" href="#sending-emails">Sending Emails</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#partners-and-resellers">Partners and Resellers</a><ul>
<li><a class="reference internal" href="#resellers">Resellers</a><ul>
<li><a class="reference internal" href="#license">License</a></li>
<li><a class="reference internal" href="#main-asterisell-instance-configuration">Main Asterisell Instance Configuration</a></li>
<li><a class="reference internal" href="#reseller-instance-configuration">Reseller Instance Configuration</a></li>
<li><a class="reference internal" href="#rerating-of-cdrs">Rerating of CDRs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#partners">Partners</a><ul>
<li><a class="reference internal" href="#id9">License</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#id10">Invoices</a></li>
<li><a class="reference internal" href="#custom-login-page">Custom Login Page</a></li>
</ul>
</li>
<li><a class="reference internal" href="#main-configuration-file-content">Main Configuration File Content</a></li>
</ul>
</li>
<li><a class="reference internal" href="#development">Development</a><ul>
<li><a class="reference internal" href="#project-repository">Project Repository</a></li>
<li><a class="reference internal" href="#symfony-framework">Symfony Framework</a></li>
<li><a class="reference internal" href="#debug">Debug</a></li>
<li><a class="reference internal" href="#localization">Localization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#glossary">Glossary</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="#">Asterisell documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Massimo Zaniboni - licensed under Creative Commons 3.0 Unported License..
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>